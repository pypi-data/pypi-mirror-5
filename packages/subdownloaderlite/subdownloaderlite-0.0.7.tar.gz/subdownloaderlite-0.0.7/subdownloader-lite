#!/usr/bin/python

import os, sys, getopt 
from subdownloader.subDownLib.subtitlErrorHandler import subtitlErrorHandler
from subdownloader.subDownLib.opensubtitles import openSubtitles
from subdownloader.subDownLib.downloadManager import downloadManager


def main(argv):
	try:
		opt, args = getopt.getopt(argv, "hi:l:", ["help", "inlude=", "lang="])
	except getopt.GetoptError, err:
		print str(err)
		usage()
		sys.exit(2)

	output = None
	verbose = False
	Language = "eng"
	Input = ""
	subtitles = downloadManager()

	for o, a in opt:
		if o in ("-h", "--help"):
		    usage()
		    sys.exit()
		elif o in ("-i", "--input"):
			Input = a
		elif o in ("-l", "--lang"):
			Language = a
		else:
		    assert False, "unhandled option"

	if Input == "":
		print "Input File/Folder must be supplied"
		usage()
		sys.exit(2)

	if not subtitles.checkLanguage(Language):
		print "Language " + Language + " not supported\n"
		usage()
		sys.exit(2)

	print "Connecting to OpenSubtitles.org"
	if subtitles.LogIn() == 0:
		print "Connection error"
		return 2

	if os.path.isdir(Input):
		print "Folder selected : " + Input
		print "Language : " + Language
		subtitles.DownloadFolder(Input,Language)
		subtitles.LogOut()
	elif os.path.isfile(Input):
		print "File selected : " + Input
		print "Language : " + Language
		retVal = subtitles.DownloadSingle(Input,Language)
		subtitles.LogOut()
		sys.exit(retVal)
	else:
		print "Unknown input " + Input
		usage()
		sys.exit(2)

def usage():
    usage = """
    -h --help                 Prints this
    -i --inupt		      Input file or directory
    -l --lang                 Language of subtitle to search
    """
    print usage

if __name__ == "__main__":
    main(sys.argv[1:]) # [1:] slices off the first argument which is the name of the program

