define(["jquery","underscore"],function(t,e){var i,s=this,n=s.Backbone,r=[],a=r.push,o=r.slice,h=r.splice;i="undefined"!=typeof exports?exports:s.Backbone={},i.VERSION="1.0.0",i.$=t,i.noConflict=function(){return s.Backbone=n,this},i.emulateHTTP=!1,i.emulateJSON=!1;var u=i.Events={on:function(t,e,i){if(!l(this,"on",t,[e,i])||!e)return this;this._events||(this._events={});var s=this._events[t]||(this._events[t]=[]);return s.push({callback:e,context:i,ctx:i||this}),this},once:function(t,i,s){if(!l(this,"once",t,[i,s])||!i)return this;var n=this,r=e.once(function(){n.off(t,r),i.apply(this,arguments)});return r._callback=i,this.on(t,r,s)},off:function(t,i,s){var n,r,a,o,h,u,c,d;if(!this._events||!l(this,"off",t,[i,s]))return this;if(!t&&!i&&!s)return this._events={},this;for(o=t?[t]:e.keys(this._events),h=0,u=o.length;u>h;h++)if(t=o[h],a=this._events[t]){if(this._events[t]=n=[],i||s)for(c=0,d=a.length;d>c;c++)r=a[c],(i&&i!==r.callback&&i!==r.callback._callback||s&&s!==r.context)&&n.push(r);n.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=o.call(arguments,1);if(!l(this,"trigger",t,e))return this;var i=this._events[t],s=this._events.all;return i&&d(i,e),s&&d(s,arguments),this},stopListening:function(t,e,i){var s=this._listeners;if(!s)return this;var n=!e&&!i;"object"==typeof e&&(i=this),t&&((s={})[t._listenerId]=t);for(var r in s)s[r].off(e,i,this),n&&delete this._listeners[r];return this}},c=/\s+/,l=function(t,e,i,s){if(!i)return!0;if("object"==typeof i){for(var n in i)t[e].apply(t,[n,i[n]].concat(s));return!1}if(c.test(i)){for(var r=i.split(c),a=0,o=r.length;o>a;a++)t[e].apply(t,[r[a]].concat(s));return!1}return!0},d=function(t,e){var i,s=-1,n=t.length,r=e[0],a=e[1],o=e[2];switch(e.length){case 0:for(;++s<n;)(i=t[s]).callback.call(i.ctx);return;case 1:for(;++s<n;)(i=t[s]).callback.call(i.ctx,r);return;case 2:for(;++s<n;)(i=t[s]).callback.call(i.ctx,r,a);return;case 3:for(;++s<n;)(i=t[s]).callback.call(i.ctx,r,a,o);return;default:for(;++s<n;)(i=t[s]).callback.apply(i.ctx,e)}},f={listenTo:"on",listenToOnce:"once"};e.each(f,function(t,i){u[i]=function(i,s,n){var r=this._listeners||(this._listeners={}),a=i._listenerId||(i._listenerId=e.uniqueId("l"));return r[a]=i,"object"==typeof s&&(n=this),i[t](s,n,this),this}}),u.bind=u.on,u.unbind=u.off,e.extend(i,u);var p=i.Model=function(t,i){var s,n=t||{};i||(i={}),this.cid=e.uniqueId("c"),this.attributes={},e.extend(this,e.pick(i,g)),i.parse&&(n=this.parse(n,i)||{}),(s=e.result(this,"defaults"))&&(n=e.defaults({},n,s)),this.set(n,i),this.changed={},this.initialize.apply(this,arguments)},g=["url","urlRoot","collection"];e.extend(p.prototype,u,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return e.clone(this.attributes)},sync:function(){return i.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return e.escape(this.get(t))},has:function(t){return null!=this.get(t)},set:function(t,i,s){var n,r,a,o,h,u,c,l;if(null==t)return this;if("object"==typeof t?(r=t,s=i):(r={})[t]=i,s||(s={}),!this._validate(r,s))return!1;a=s.unset,h=s.silent,o=[],u=this._changing,this._changing=!0,u||(this._previousAttributes=e.clone(this.attributes),this.changed={}),l=this.attributes,c=this._previousAttributes,this.idAttribute in r&&(this.id=r[this.idAttribute]);for(n in r)i=r[n],e.isEqual(l[n],i)||o.push(n),e.isEqual(c[n],i)?delete this.changed[n]:this.changed[n]=i,a?delete l[n]:l[n]=i;if(!h){o.length&&(this._pending=!0);for(var d=0,f=o.length;f>d;d++)this.trigger("change:"+o[d],this,l[o[d]],s)}if(u)return this;if(!h)for(;this._pending;)this._pending=!1,this.trigger("change",this,s);return this._pending=!1,this._changing=!1,this},unset:function(t,i){return this.set(t,void 0,e.extend({},i,{unset:!0}))},clear:function(t){var i={};for(var s in this.attributes)i[s]=void 0;return this.set(i,e.extend({},t,{unset:!0}))},hasChanged:function(t){return null==t?!e.isEmpty(this.changed):e.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?e.clone(this.changed):!1;var i,s=!1,n=this._changing?this._previousAttributes:this.attributes;for(var r in t)e.isEqual(n[r],i=t[r])||((s||(s={}))[r]=i);return s},previous:function(t){return null!=t&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return e.clone(this._previousAttributes)},fetch:function(t){t=t?e.clone(t):{},void 0===t.parse&&(t.parse=!0);var i=this,s=t.success;return t.success=function(e){return i.set(i.parse(e,t),t)?(s&&s(i,e,t),i.trigger("sync",i,e,t),void 0):!1},M(this,t),this.sync("read",this,t)},save:function(t,i,s){var n,r,a,o=this.attributes;if(null==t||"object"==typeof t?(n=t,s=i):(n={})[t]=i,!(!n||s&&s.wait||this.set(n,s)))return!1;if(s=e.extend({validate:!0},s),!this._validate(n,s))return!1;n&&s.wait&&(this.attributes=e.extend({},o,n)),void 0===s.parse&&(s.parse=!0);var h=this,u=s.success;return s.success=function(t){h.attributes=o;var i=h.parse(t,s);return s.wait&&(i=e.extend(n||{},i)),e.isObject(i)&&!h.set(i,s)?!1:(u&&u(h,t,s),h.trigger("sync",h,t,s),void 0)},M(this,s),r=this.isNew()?"create":s.patch?"patch":"update","patch"===r&&(s.attrs=n),a=this.sync(r,this,s),n&&s.wait&&(this.attributes=o),a},destroy:function(t){t=t?e.clone(t):{};var i=this,s=t.success,n=function(){i.trigger("destroy",i,i.collection,t)};if(t.success=function(e){(t.wait||i.isNew())&&n(),s&&s(i,e,t),i.isNew()||i.trigger("sync",i,e,t)},this.isNew())return t.success(),!1;M(this,t);var r=this.sync("delete",this,t);return t.wait||n(),r},url:function(){var t=e.result(this,"urlRoot")||e.result(this.collection,"url")||R();return this.isNew()?t:t+("/"===t.charAt(t.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(t){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},isValid:function(t){return this._validate({},e.extend(t||{},{validate:!0}))},_validate:function(t,i){if(!i.validate||!this.validate)return!0;t=e.extend({},this.attributes,t);var s=this.validationError=this.validate(t,i)||null;return s?(this.trigger("invalid",this,s,e.extend(i||{},{validationError:s})),!1):!0}});var v=["keys","values","pairs","invert","pick","omit"];e.each(v,function(t){p.prototype[t]=function(){var i=o.call(arguments);return i.unshift(this.attributes),e[t].apply(e,i)}});var m=i.Collection=function(t,i){i||(i={}),i.url&&(this.url=i.url),i.model&&(this.model=i.model),void 0!==i.comparator&&(this.comparator=i.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,e.extend({silent:!0},i))},y={add:!0,remove:!0,merge:!0},_={add:!0,merge:!1,remove:!1};e.extend(m.prototype,u,{model:p,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return i.sync.apply(this,arguments)},add:function(t,i){return this.set(t,e.defaults(i||{},_))},remove:function(t,i){t=e.isArray(t)?t.slice():[t],i||(i={});var s,n,r,a;for(s=0,n=t.length;n>s;s++)a=this.get(t[s]),a&&(delete this._byId[a.id],delete this._byId[a.cid],r=this.indexOf(a),this.models.splice(r,1),this.length--,i.silent||(i.index=r,a.trigger("remove",a,this,i)),this._removeReference(a));return this},set:function(t,i){i=e.defaults(i||{},y),i.parse&&(t=this.parse(t,i)),e.isArray(t)||(t=t?[t]:[]);var s,n,r,o,u,c=i.at,l=this.comparator&&null==c&&i.sort!==!1,d=e.isString(this.comparator)?this.comparator:null,f=[],p=[],g={};for(s=0,n=t.length;n>s;s++)(r=this._prepareModel(t[s],i))&&((o=this.get(r))?(i.remove&&(g[o.cid]=!0),i.merge&&(o.set(r.attributes,i),l&&!u&&o.hasChanged(d)&&(u=!0))):i.add&&(f.push(r),r.on("all",this._onModelEvent,this),this._byId[r.cid]=r,null!=r.id&&(this._byId[r.id]=r)));if(i.remove){for(s=0,n=this.length;n>s;++s)g[(r=this.models[s]).cid]||p.push(r);p.length&&this.remove(p,i)}if(f.length&&(l&&(u=!0),this.length+=f.length,null!=c?h.apply(this.models,[c,0].concat(f)):a.apply(this.models,f)),u&&this.sort({silent:!0}),i.silent)return this;for(s=0,n=f.length;n>s;s++)(r=f[s]).trigger("add",r,this,i);return u&&this.trigger("sort",this,i),this},reset:function(t,i){i||(i={});for(var s=0,n=this.models.length;n>s;s++)this._removeReference(this.models[s]);return i.previousModels=this.models,this._reset(),this.add(t,e.extend({silent:!0},i)),i.silent||this.trigger("reset",this,i),this},push:function(t,i){return t=this._prepareModel(t,i),this.add(t,e.extend({at:this.length},i)),t},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t),e},unshift:function(t,i){return t=this._prepareModel(t,i),this.add(t,e.extend({at:0},i)),t},shift:function(t){var e=this.at(0);return this.remove(e,t),e},slice:function(t,e){return this.models.slice(t,e)},get:function(t){return null==t?void 0:this._byId[null!=t.id?t.id:t.cid||t]},at:function(t){return this.models[t]},where:function(t,i){return e.isEmpty(t)?i?void 0:[]:this[i?"find":"filter"](function(e){for(var i in t)if(t[i]!==e.get(i))return!1;return!0})},findWhere:function(t){return this.where(t,!0)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return t||(t={}),e.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(e.bind(this.comparator,this)),t.silent||this.trigger("sort",this,t),this},sortedIndex:function(t,i,s){i||(i=this.comparator);var n=e.isFunction(i)?i:function(t){return t.get(i)};return e.sortedIndex(this.models,t,n,s)},pluck:function(t){return e.invoke(this.models,"get",t)},fetch:function(t){t=t?e.clone(t):{},void 0===t.parse&&(t.parse=!0);var i=t.success,s=this;return t.success=function(e){var n=t.reset?"reset":"set";s[n](e,t),i&&i(s,e,t),s.trigger("sync",s,e,t)},M(this,t),this.sync("read",this,t)},create:function(t,i){if(i=i?e.clone(i):{},!(t=this._prepareModel(t,i)))return!1;i.wait||this.add(t,i);var s=this,n=i.success;return i.success=function(e){i.wait&&s.add(t,i),n&&n(t,e,i)},t.save(null,i),t},parse:function(t){return t},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(t,e){if(t instanceof p)return t.collection||(t.collection=this),t;e||(e={}),e.collection=this;var i=new this.model(t,e);return i._validate(t,e)?i:(this.trigger("invalid",this,t,e),!1)},_removeReference:function(t){this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,s){("add"!==t&&"remove"!==t||i===this)&&("destroy"===t&&this.remove(e,s),e&&t==="change:"+e.idAttribute&&(delete this._byId[e.previous(e.idAttribute)],null!=e.id&&(this._byId[e.id]=e)),this.trigger.apply(this,arguments))}});var b=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];e.each(b,function(t){m.prototype[t]=function(){var i=o.call(arguments);return i.unshift(this.models),e[t].apply(e,i)}});var w=["groupBy","countBy","sortBy"];e.each(w,function(t){m.prototype[t]=function(i,s){var n=e.isFunction(i)?i:function(t){return t.get(i)};return e[t](this.models,n,s)}});var x=i.View=function(t){this.cid=e.uniqueId("view"),this._configure(t||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},E=/^(\S+)\s*(.*)$/,k=["model","collection","el","id","attributes","className","tagName","events"];e.extend(x.prototype,u,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(t,e){return this.$el&&this.undelegateEvents(),this.$el=t instanceof i.$?t:i.$(t),this.el=this.$el[0],e!==!1&&this.delegateEvents(),this},delegateEvents:function(t){if(!t&&!(t=e.result(this,"events")))return this;this.undelegateEvents();for(var i in t){var s=t[i];if(e.isFunction(s)||(s=this[t[i]]),s){var n=i.match(E),r=n[1],a=n[2];s=e.bind(s,this),r+=".delegateEvents"+this.cid,""===a?this.$el.on(r,s):this.$el.on(r,a,s)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(t){this.options&&(t=e.extend({},e.result(this,"options"),t)),e.extend(this,e.pick(t,k)),this.options=t},_ensureElement:function(){if(this.el)this.setElement(e.result(this,"el"),!1);else{var t=e.extend({},e.result(this,"attributes"));this.id&&(t.id=e.result(this,"id")),this.className&&(t["class"]=e.result(this,"className"));var s=i.$("<"+e.result(this,"tagName")+">").attr(t);this.setElement(s,!1)}}}),i.sync=function(t,s,n){var r=S[t];e.defaults(n||(n={}),{emulateHTTP:i.emulateHTTP,emulateJSON:i.emulateJSON});var a={type:r,dataType:"json"};if(n.url||(a.url=e.result(s,"url")||R()),null!=n.data||!s||"create"!==t&&"update"!==t&&"patch"!==t||(a.contentType="application/json",a.data=JSON.stringify(n.attrs||s.toJSON(n))),n.emulateJSON&&(a.contentType="application/x-www-form-urlencoded",a.data=a.data?{model:a.data}:{}),n.emulateHTTP&&("PUT"===r||"DELETE"===r||"PATCH"===r)){a.type="POST",n.emulateJSON&&(a.data._method=r);var o=n.beforeSend;n.beforeSend=function(t){return t.setRequestHeader("X-HTTP-Method-Override",r),o?o.apply(this,arguments):void 0}}"GET"===a.type||n.emulateJSON||(a.processData=!1),"PATCH"!==a.type||!window.ActiveXObject||window.external&&window.external.msActiveXFilteringEnabled||(a.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var h=n.xhr=i.ajax(e.extend(a,n));return s.trigger("request",s,h,n),h};var S={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};i.ajax=function(){return i.$.ajax.apply(i.$,arguments)};var T=i.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},$=/\((.*?)\)/g,H=/(\(\?)?:\w+/g,A=/\*\w+/g,I=/[\-{}\[\]+?.,\\\^$|#\s]/g;e.extend(T.prototype,u,{initialize:function(){},route:function(t,s,n){e.isRegExp(t)||(t=this._routeToRegExp(t)),e.isFunction(s)&&(n=s,s=""),n||(n=this[s]);var r=this;return i.history.route(t,function(e){var a=r._extractParameters(t,e);n&&n.apply(r,a),r.trigger.apply(r,["route:"+s].concat(a)),r.trigger("route",s,a),i.history.trigger("route",r,s,a)}),this},navigate:function(t,e){return i.history.navigate(t,e),this},_bindRoutes:function(){if(this.routes){this.routes=e.result(this,"routes");for(var t,i=e.keys(this.routes);null!=(t=i.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(I,"\\$&").replace($,"(?:$1)?").replace(H,function(t,e){return e?t:"([^/]+)"}).replace(A,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,i){var s=t.exec(i).slice(1);return e.map(s,function(t){return t?decodeURIComponent(t):null})}});var N=i.History=function(){this.handlers=[],e.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},P=/^[#\/]|\s+$/g,O=/^\/+|\/+$/g,C=/msie [\w.]+/,j=/\/$/;N.started=!1,e.extend(N.prototype,u,{interval:50,getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(null==t)if(this._hasPushState||!this._wantsHashChange||e){t=this.location.pathname;var i=this.root.replace(j,"");t.indexOf(i)||(t=t.substr(i.length))}else t=this.getHash();return t.replace(P,"")},start:function(t){if(N.started)throw new Error("Backbone.history has already been started");N.started=!0,this.options=e.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var s=this.getFragment(),n=document.documentMode,r=C.exec(navigator.userAgent.toLowerCase())&&(!n||7>=n);this.root=("/"+this.root+"/").replace(O,"/"),r&&this._wantsHashChange&&(this.iframe=i.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(s)),this._hasPushState?i.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?i.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=s;var a=this.location,o=a.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!o?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&o&&a.hash&&(this.fragment=this.getHash().replace(P,""),this.history.replaceState({},document.title,this.root+this.fragment+a.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){i.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),N.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash()),void 0)},loadUrl:function(t){var i=this.fragment=this.getFragment(t),s=e.any(this.handlers,function(t){return t.route.test(i)?(t.callback(i),!0):void 0});return s},navigate:function(t,e){if(!N.started)return!1;if(e&&e!==!0||(e={trigger:e}),t=this.getFragment(t||""),this.fragment!==t){this.fragment=t;var i=this.root+t;if(this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,i);else{if(!this._wantsHashChange)return this.location.assign(i);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}return e.trigger?this.loadUrl(t):void 0}},_updateHash:function(t,e,i){if(i){var s=t.href.replace(/(javascript:|#).*$/,"");t.replace(s+"#"+e)}else t.hash="#"+e}}),i.history=new N;var U=function(t,i){var s,n=this;s=t&&e.has(t,"constructor")?t.constructor:function(){return n.apply(this,arguments)},e.extend(s,n,i);var r=function(){this.constructor=s};return r.prototype=n.prototype,s.prototype=new r,t&&e.extend(s.prototype,t),s.__super__=n.prototype,s};p.extend=m.extend=T.extend=x.extend=N.extend=U;var R=function(){throw new Error('A "url" property or function must be specified')},M=function(t,e){var i=e.error;e.error=function(s){i&&i(t,s,e),t.trigger("error",t,s,e)}};return i});