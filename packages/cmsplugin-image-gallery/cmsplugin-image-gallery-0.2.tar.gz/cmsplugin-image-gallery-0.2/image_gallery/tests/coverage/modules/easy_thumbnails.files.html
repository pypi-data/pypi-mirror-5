<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: easy_thumbnails.files</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="easy_thumbnails.fields.html">easy_thumbnails.fields</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="easy_thumbnails.management.__init__.html">easy_thumbnails.management.__init__</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">easy_thumbnails.files</span>:
    294 total statements,
    <span class="critical">0.0% covered</span>
  </h1>
  <p>Generated: Wed 2013-03-13 10:33 CET</p>
  <p>Source file: /media/Envs/Envs/filer-gallery/lib/python2.7/site-packages/easy_thumbnails/files.py</p>
  <p>
    Stats:
    <span class="executed">0 executed</span>,
    <span class="missed">283 missed</span>,
    <span class="excluded">11 excluded</span>,
    <span class="ignored">292 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="excluded"><code>from django.core.files.base import File, ContentFile</code></li>
<li class="excluded"><code>from django.core.files.storage import get_storage_class, default_storage, \</code></li>
<li class="ignored"><code>    Storage</code></li>
<li class="excluded"><code>from django.db.models.fields.files import ImageFieldFile, FieldFile</code></li>
<li class="excluded"><code>import os</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from django.utils.safestring import mark_safe</code></li>
<li class="excluded"><code>from django.utils.html import escape</code></li>
<li class="excluded"><code>from django.utils.http import urlquote</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from easy_thumbnails import engine, exceptions, models, utils, signals</code></li>
<li class="excluded"><code>from easy_thumbnails.alias import aliases</code></li>
<li class="excluded"><code>from easy_thumbnails.conf import settings</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def get_thumbnailer(obj, relative_name=None):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    Get a :class:`Thumbnailer` for a source file.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    The ``obj`` argument is usually either one of the following:</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        * ``FieldFile`` instance (i.e. a model instance file/image field</code></li>
<li class="ignored"><code>          property).</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        * A string, which will be used as the relative name (the source will be</code></li>
<li class="ignored"><code>          set to the default storage).</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        * ``Storage`` instance - the ``relative_name`` argument must also be</code></li>
<li class="ignored"><code>          provided.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    Or it could be:</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        * A file-like instance - the ``relative_name`` argument must also be</code></li>
<li class="ignored"><code>          provided.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>          In this case, the thumbnailer won't use or create a cached reference</code></li>
<li class="ignored"><code>          to the thumbnail (i.e. a new thumbnail will be created for every</code></li>
<li class="ignored"><code>          :meth:`Thumbnailer.get_thumbnail` call).</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    If ``obj`` is a ``Thumbnailer`` instance, it will just be returned. If it's</code></li>
<li class="ignored"><code>    an object with an ``easy_thumbnails_thumbnailer`` then the attribute is</code></li>
<li class="ignored"><code>    simply returned under the assumption it is a Thumbnailer instance)</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    if hasattr(obj, 'easy_thumbnails_thumbnailer'):</code></li>
<li class="missed"><code>        return obj.easy_thumbnails_thumbnailer</code></li>
<li class="missed"><code>    if isinstance(obj, Thumbnailer):</code></li>
<li class="missed"><code>        return obj</code></li>
<li class="missed"><code>    elif isinstance(obj, FieldFile):</code></li>
<li class="missed"><code>        if not relative_name:</code></li>
<li class="missed"><code>            relative_name = obj.name</code></li>
<li class="missed"><code>        return ThumbnailerFieldFile(obj.instance, obj.field, relative_name)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    source_storage = None</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    if isinstance(obj, basestring):</code></li>
<li class="missed"><code>        relative_name = obj</code></li>
<li class="missed"><code>        obj = None</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    if not relative_name:</code></li>
<li class="missed"><code>        raise ValueError("If object is not a FieldFile or Thumbnailer "</code></li>
<li class="ignored"><code>            "instance, the relative name must be provided")</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    if isinstance(obj, File):</code></li>
<li class="missed"><code>        obj = obj.file</code></li>
<li class="missed"><code>    if isinstance(obj, Storage) or obj == default_storage:</code></li>
<li class="missed"><code>        source_storage = obj</code></li>
<li class="missed"><code>        obj = None</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    return Thumbnailer(file=obj, name=relative_name,</code></li>
<li class="ignored"><code>        source_storage=source_storage, remote_source=obj is not None)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def save_thumbnail(thumbnail_file, storage):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    Save a thumbnailed file, returning the saved relative file name.</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    filename = thumbnail_file.name</code></li>
<li class="missed"><code>    if storage.exists(filename):</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            storage.delete(filename)</code></li>
<li class="missed"><code>        except:</code></li>
<li class="missed"><code>            pass</code></li>
<li class="missed"><code>    return storage.save(filename, thumbnail_file)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def generate_all_aliases(fieldfile, include_global):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    Generate all of a file's aliases.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    :param fieldfile: A ``FieldFile`` instance.</code></li>
<li class="ignored"><code>    :param include_global: A boolean which determines whether to generate</code></li>
<li class="ignored"><code>        thumbnails for project-wide aliases in addition to field, model, and</code></li>
<li class="ignored"><code>        app specific aliases.</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    all_options = aliases.all(fieldfile, include_global=include_global)</code></li>
<li class="missed"><code>    if all_options:</code></li>
<li class="missed"><code>        thumbnailer = get_thumbnailer(fieldfile)</code></li>
<li class="missed"><code>        for options in all_options.values():</code></li>
<li class="missed"><code>            thumbnailer.get_thumbnail(options)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class FakeField(object):</code></li>
<li class="missed"><code>    name = 'fake'</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def __init__(self, storage=None):</code></li>
<li class="missed"><code>        self.storage = storage or default_storage</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def generate_filename(self, instance, name, *args, **kwargs):</code></li>
<li class="missed"><code>        return name</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class FakeInstance(object):</code></li>
<li class="missed"><code>    def save(self, *args, **kwargs):</code></li>
<li class="missed"><code>        pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class ThumbnailFile(ImageFieldFile):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    A thumbnailed file.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    This can be used just like a Django model instance's property for a file</code></li>
<li class="ignored"><code>    field (i.e. an ``ImageFieldFile`` object).</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    def __init__(self, name, file=None, storage=None, thumbnail_options=None,</code></li>
<li class="ignored"><code>            *args, **kwargs):</code></li>
<li class="missed"><code>        fake_field = FakeField(storage=storage)</code></li>
<li class="missed"><code>        super(ThumbnailFile, self).__init__(FakeInstance(), fake_field, name,</code></li>
<li class="ignored"><code>            *args, **kwargs)</code></li>
<li class="missed"><code>        del self.field</code></li>
<li class="missed"><code>        if file:</code></li>
<li class="missed"><code>            self.file = file</code></li>
<li class="missed"><code>        self.thumbnail_options = thumbnail_options</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _get_image(self):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Get a PIL Image instance of this file.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        The image is cached to avoid the file needing to be read again if the</code></li>
<li class="ignored"><code>        function is called again.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        if not hasattr(self, '_image_cache'):</code></li>
<li class="excluded"><code>            from easy_thumbnails.source_generators import pil_image</code></li>
<li class="missed"><code>            self.image = pil_image(self)</code></li>
<li class="missed"><code>        return self._image_cache</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _set_image(self, image):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Set the image for this file.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        This also caches the dimensions of the image.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        if image:</code></li>
<li class="missed"><code>            self._image_cache = image</code></li>
<li class="missed"><code>            self._dimensions_cache = image.size</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            if hasattr(self, '_image_cache'):</code></li>
<li class="missed"><code>                del self._cached_image</code></li>
<li class="missed"><code>            if hasattr(self, '_dimensions_cache'):</code></li>
<li class="missed"><code>                del self._dimensions_cache</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    image = property(_get_image, _set_image)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def tag(self, alt='', use_size=None, **attrs):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Return a standard XHTML ``&lt;img ... /&gt;`` tag for this field.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        :param alt: The ``alt=""`` text for the tag. Defaults to ``''``.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        :param use_size: Whether to get the size of the thumbnail image for use in</code></li>
<li class="ignored"><code>            the tag attributes. If ``None`` (default), it will be ``True`` or</code></li>
<li class="ignored"><code>            ``False`` depending on whether the file storage is local or not.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        All other keyword parameters are added as (properly escaped) extra</code></li>
<li class="ignored"><code>        attributes to the `img` tag.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        if use_size is None:</code></li>
<li class="missed"><code>            try:</code></li>
<li class="missed"><code>                self.storage.path(self.name)</code></li>
<li class="missed"><code>                use_size = True</code></li>
<li class="missed"><code>            except NotImplementedError:</code></li>
<li class="missed"><code>                use_size = False</code></li>
<li class="missed"><code>        attrs['alt'] = alt</code></li>
<li class="missed"><code>        attrs['src'] = self.url</code></li>
<li class="missed"><code>        if use_size:</code></li>
<li class="missed"><code>            attrs.update(dict(width=self.width, height=self.height))</code></li>
<li class="missed"><code>        attrs = ' '.join(['%s="%s"' % (key, escape(value))</code></li>
<li class="ignored"><code>                          for key, value in sorted(attrs.items())])</code></li>
<li class="missed"><code>        return mark_safe('&lt;img %s /&gt;' % attrs)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _get_file(self):</code></li>
<li class="missed"><code>        self._require_file()</code></li>
<li class="missed"><code>        if not hasattr(self, '_file') or self._file is None:</code></li>
<li class="missed"><code>            self._file = self.storage.open(self.name, 'rb')</code></li>
<li class="missed"><code>        return self._file</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _set_file(self, value):</code></li>
<li class="missed"><code>        if value is not None and not isinstance(value, File):</code></li>
<li class="missed"><code>            value = File(value)</code></li>
<li class="missed"><code>        self._file = value</code></li>
<li class="missed"><code>        self._committed = False</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _del_file(self):</code></li>
<li class="missed"><code>        del self._file</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    file = property(_get_file, _set_file, _del_file)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _get_url(self):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Return the full url of this file.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        .. note:: storages should already be quoting the urls, but Django's</code></li>
<li class="ignored"><code>                  built in ``FileSystemStorage`` doesn't.</code></li>
<li class="ignored"><code>                  ``ThumbnailFieldFile`` works around a common case of the file</code></li>
<li class="ignored"><code>                  containing a ``#``, which shouldn't ever be used for a url.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        url = super(ThumbnailFile, self).url</code></li>
<li class="missed"><code>        if '#' in url:</code></li>
<li class="missed"><code>            url = urlquote(url)</code></li>
<li class="missed"><code>        return url</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    url = property(_get_url)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def open(self, mode=None, *args, **kwargs):</code></li>
<li class="missed"><code>        if self.closed and self.name:</code></li>
<li class="missed"><code>            mode = mode or getattr(self, 'mode', None) or 'rb'</code></li>
<li class="missed"><code>            self.file = self.storage.open(self.name, mode)</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            return super(ThumbnailFile, self).open(mode, *args, **kwargs)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class Thumbnailer(File):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    A file-like object which provides some methods to generate thumbnail</code></li>
<li class="ignored"><code>    images.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    You can subclass this object and override the following properties to</code></li>
<li class="ignored"><code>    change the defaults (pulled from the default settings):</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        * source_generators</code></li>
<li class="ignored"><code>        * thumbnail_processors</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    source_generators = None</code></li>
<li class="missed"><code>    thumbnail_processors = None</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def __init__(self, file=None, name=None, source_storage=None,</code></li>
<li class="ignored"><code>            thumbnail_storage=None, remote_source=False, generate=True, *args,</code></li>
<li class="ignored"><code>            **kwargs):</code></li>
<li class="missed"><code>        super(Thumbnailer, self).__init__(file, name, *args, **kwargs)</code></li>
<li class="missed"><code>        self.source_storage = source_storage or default_storage</code></li>
<li class="missed"><code>        if not thumbnail_storage:</code></li>
<li class="missed"><code>            thumbnail_storage = get_storage_class(</code></li>
<li class="ignored"><code>                settings.THUMBNAIL_DEFAULT_STORAGE)()</code></li>
<li class="missed"><code>        self.thumbnail_storage = thumbnail_storage</code></li>
<li class="missed"><code>        self.remote_source = remote_source</code></li>
<li class="missed"><code>        self.alias_target = None</code></li>
<li class="missed"><code>        self.generate = generate</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        # Set default properties. For backwards compatibilty, check to see</code></li>
<li class="ignored"><code>        # if the attribute exists already (it could be set as a class property</code></li>
<li class="ignored"><code>        # on a subclass) before getting it from settings.</code></li>
<li class="missed"><code>        for default in ('basedir', 'subdir', 'prefix', 'quality', 'extension',</code></li>
<li class="ignored"><code>                'preserve_extensions', 'transparency_extension',</code></li>
<li class="ignored"><code>                'check_cache_miss'):</code></li>
<li class="missed"><code>            attr_name = 'thumbnail_%s' % default</code></li>
<li class="missed"><code>            if getattr(self, attr_name, None) is None:</code></li>
<li class="missed"><code>                value = getattr(settings, attr_name.upper())</code></li>
<li class="missed"><code>                setattr(self, attr_name, value)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def __getitem__(self, alias):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Retrieve a thumbnail matching the alias options (or raise a</code></li>
<li class="ignored"><code>        ``KeyError`` if no such alias exists).</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        options = aliases.get(alias, target=self.alias_target)</code></li>
<li class="missed"><code>        if not options:</code></li>
<li class="missed"><code>            raise KeyError(alias)</code></li>
<li class="missed"><code>        return self.get_thumbnail(options)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def generate_source_image(self, thumbnail_options):</code></li>
<li class="missed"><code>        return engine.generate_source_image(self, thumbnail_options,</code></li>
<li class="ignored"><code>                                            self.source_generators)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def generate_thumbnail(self, thumbnail_options):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Return an unsaved ``ThumbnailFile`` containing a thumbnail image.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        The thumbnail image is generated using the ``thumbnail_options``</code></li>
<li class="ignored"><code>        dictionary.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        image = self.generate_source_image(thumbnail_options)</code></li>
<li class="missed"><code>        if image is None:</code></li>
<li class="missed"><code>            raise exceptions.InvalidImageFormatError(</code></li>
<li class="ignored"><code>                "The source file does not appear to be an image")</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        thumbnail_image = engine.process_image(image, thumbnail_options,</code></li>
<li class="ignored"><code>                                               self.thumbnail_processors)</code></li>
<li class="missed"><code>        quality = thumbnail_options.get('quality', self.thumbnail_quality)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        filename = self.get_thumbnail_name(thumbnail_options,</code></li>
<li class="ignored"><code>            transparent=utils.is_transparent(thumbnail_image))</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        data = engine.save_image(thumbnail_image, filename=filename,</code></li>
<li class="ignored"><code>            quality=quality).read()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        thumbnail = ThumbnailFile(filename, file=ContentFile(data),</code></li>
<li class="ignored"><code>            storage=self.thumbnail_storage,</code></li>
<li class="ignored"><code>            thumbnail_options=thumbnail_options)</code></li>
<li class="missed"><code>        thumbnail.image = thumbnail_image</code></li>
<li class="missed"><code>        thumbnail._committed = False</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        return thumbnail</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_thumbnail_name(self, thumbnail_options, transparent=False):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Return a thumbnail filename for the given ``thumbnail_options``</code></li>
<li class="ignored"><code>        dictionary and ``source_name`` (which defaults to the File's ``name``</code></li>
<li class="ignored"><code>        if not provided).</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        path, source_filename = os.path.split(self.name)</code></li>
<li class="missed"><code>        source_extension = os.path.splitext(source_filename)[1][1:]</code></li>
<li class="missed"><code>        filename = '%s%s' % (self.thumbnail_prefix, source_filename)</code></li>
<li class="missed"><code>        if self.thumbnail_preserve_extensions == True or  \</code></li>
<li class="ignored"><code>            (self.thumbnail_preserve_extensions and  \</code></li>
<li class="ignored"><code>            source_extension.lower() in self.thumbnail_preserve_extensions):</code></li>
<li class="missed"><code>                extension = source_extension</code></li>
<li class="missed"><code>        elif transparent:</code></li>
<li class="missed"><code>            extension = self.thumbnail_transparency_extension</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            extension = self.thumbnail_extension</code></li>
<li class="missed"><code>        extension = extension or 'jpg'</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        thumbnail_options = thumbnail_options.copy()</code></li>
<li class="missed"><code>        size = tuple(thumbnail_options.pop('size'))</code></li>
<li class="missed"><code>        quality = thumbnail_options.pop('quality', self.thumbnail_quality)</code></li>
<li class="missed"><code>        initial_opts = ['%sx%s' % size, 'q%s' % quality]</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        opts = thumbnail_options.items()</code></li>
<li class="missed"><code>        opts.sort()   # Sort the options so the file name is consistent.</code></li>
<li class="missed"><code>        opts = ['%s' % (v is not True and '%s-%s' % (k, v) or k)</code></li>
<li class="ignored"><code>                for k, v in opts if v]</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        all_opts = '_'.join(initial_opts + opts)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        data = {'opts': all_opts}</code></li>
<li class="missed"><code>        basedir = self.thumbnail_basedir % data</code></li>
<li class="missed"><code>        subdir = self.thumbnail_subdir % data</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        filename_parts = [filename]</code></li>
<li class="missed"><code>        if ('%(opts)s' in self.thumbnail_basedir or</code></li>
<li class="ignored"><code>            '%(opts)s' in self.thumbnail_subdir):</code></li>
<li class="missed"><code>            if extension != source_extension:</code></li>
<li class="missed"><code>                filename_parts.append(extension)</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            filename_parts += [all_opts, extension]</code></li>
<li class="missed"><code>        filename = '.'.join(filename_parts)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        return os.path.join(basedir, path, subdir, filename)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_thumbnail(self, thumbnail_options, save=True, generate=None):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Return a ``ThumbnailFile`` containing a thumbnail.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        If a matching thumbnail already exists, it will simply be returned.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        By default (unless the ``Thumbnailer`` was instanciated with</code></li>
<li class="ignored"><code>        ``generate=False``), thumbnails that don't exist are generated.</code></li>
<li class="ignored"><code>        Otherwise ``None`` is returned.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        Force the generation behaviour by setting the ``generate`` param to</code></li>
<li class="ignored"><code>        either ``True`` or ``False`` as required.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        The new thumbnail image is generated using the ``thumbnail_options``</code></li>
<li class="ignored"><code>        dictionary. If the ``save`` argument is ``True`` (default), the</code></li>
<li class="ignored"><code>        generated thumbnail will be saved too.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        opaque_name = self.get_thumbnail_name(thumbnail_options,</code></li>
<li class="ignored"><code>                                              transparent=False)</code></li>
<li class="missed"><code>        transparent_name = self.get_thumbnail_name(thumbnail_options,</code></li>
<li class="ignored"><code>                                                   transparent=True)</code></li>
<li class="missed"><code>        if opaque_name == transparent_name:</code></li>
<li class="missed"><code>            names = (opaque_name,)</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            names = (opaque_name, transparent_name)</code></li>
<li class="missed"><code>        for filename in names:</code></li>
<li class="missed"><code>            if self.thumbnail_exists(filename):</code></li>
<li class="missed"><code>                return ThumbnailFile(name=filename,</code></li>
<li class="ignored"><code>                    storage=self.thumbnail_storage,</code></li>
<li class="ignored"><code>                    thumbnail_options=thumbnail_options)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        if generate is None:</code></li>
<li class="missed"><code>            generate = self.generate</code></li>
<li class="missed"><code>        if not generate:</code></li>
<li class="missed"><code>            signals.thumbnail_missed.send(sender=self,</code></li>
<li class="ignored"><code>                options=thumbnail_options)</code></li>
<li class="missed"><code>            return</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        thumbnail = self.generate_thumbnail(thumbnail_options)</code></li>
<li class="missed"><code>        if save:</code></li>
<li class="missed"><code>            save_thumbnail(thumbnail, self.thumbnail_storage)</code></li>
<li class="missed"><code>            signals.thumbnail_created.send(sender=thumbnail)</code></li>
<li class="ignored"><code>            # Ensure the right thumbnail name is used based on the transparency</code></li>
<li class="ignored"><code>            # of the image.</code></li>
<li class="missed"><code>            filename = (utils.is_transparent(thumbnail.image) and</code></li>
<li class="ignored"><code>                        transparent_name or opaque_name)</code></li>
<li class="missed"><code>            self.get_thumbnail_cache(filename, create=True, update=True)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        return thumbnail</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def thumbnail_exists(self, thumbnail_name):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Calculate whether the thumbnail already exists and that the source is</code></li>
<li class="ignored"><code>        not newer than the thumbnail.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        If both the source and thumbnail file storages are local, their</code></li>
<li class="ignored"><code>        file modification times are used. Otherwise the database cached</code></li>
<li class="ignored"><code>        modification times are used.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        if self.remote_source:</code></li>
<li class="missed"><code>            return False</code></li>
<li class="ignored"><code>        # Try to use the local file modification times first.</code></li>
<li class="missed"><code>        source_modtime = self.get_source_modtime()</code></li>
<li class="missed"><code>        thumbnail_modtime = self.get_thumbnail_modtime(thumbnail_name)</code></li>
<li class="ignored"><code>        # The thumbnail modification time will be 0 if there was an OSError,</code></li>
<li class="ignored"><code>        # in which case it will still be used (but always return False).</code></li>
<li class="missed"><code>        if source_modtime and thumbnail_modtime is not None:</code></li>
<li class="missed"><code>            return thumbnail_modtime and source_modtime &lt;= thumbnail_modtime</code></li>
<li class="ignored"><code>        # Fall back to using the database cached modification times.</code></li>
<li class="missed"><code>        source = self.get_source_cache()</code></li>
<li class="missed"><code>        if not source:</code></li>
<li class="missed"><code>            return False</code></li>
<li class="missed"><code>        thumbnail = self.get_thumbnail_cache(thumbnail_name)</code></li>
<li class="missed"><code>        return thumbnail and source.modified &lt;= thumbnail.modified</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_source_cache(self, create=False, update=False):</code></li>
<li class="missed"><code>        if self.remote_source:</code></li>
<li class="missed"><code>            return None</code></li>
<li class="missed"><code>        modtime = self.get_source_modtime()</code></li>
<li class="missed"><code>        update_modified = modtime and utils.fromtimestamp(modtime)</code></li>
<li class="missed"><code>        if update:</code></li>
<li class="missed"><code>            update_modified = update_modified or utils.now()</code></li>
<li class="missed"><code>        return models.Source.objects.get_file(</code></li>
<li class="ignored"><code>            create=create, update_modified=update_modified,</code></li>
<li class="ignored"><code>            storage=self.source_storage, name=self.name,</code></li>
<li class="ignored"><code>            check_cache_miss=self.thumbnail_check_cache_miss)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_thumbnail_cache(self, thumbnail_name, create=False, update=False):</code></li>
<li class="missed"><code>        if self.remote_source:</code></li>
<li class="missed"><code>            return None</code></li>
<li class="missed"><code>        modtime = self.get_thumbnail_modtime(thumbnail_name)</code></li>
<li class="missed"><code>        update_modified = modtime and utils.fromtimestamp(modtime)</code></li>
<li class="missed"><code>        if update:</code></li>
<li class="missed"><code>            update_modified = update_modified or utils.now()</code></li>
<li class="missed"><code>        source = self.get_source_cache(create=True)</code></li>
<li class="missed"><code>        return models.Thumbnail.objects.get_file(</code></li>
<li class="ignored"><code>            create=create, update_modified=update_modified,</code></li>
<li class="ignored"><code>            storage=self.thumbnail_storage, source=source, name=thumbnail_name,</code></li>
<li class="ignored"><code>            check_cache_miss=self.thumbnail_check_cache_miss)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_source_modtime(self):</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            path = self.source_storage.path(self.name)</code></li>
<li class="missed"><code>            return os.path.getmtime(path)</code></li>
<li class="missed"><code>        except OSError:</code></li>
<li class="missed"><code>            return 0</code></li>
<li class="missed"><code>        except NotImplementedError:</code></li>
<li class="missed"><code>            return None</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_thumbnail_modtime(self, thumbnail_name):</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            path = self.thumbnail_storage.path(thumbnail_name)</code></li>
<li class="missed"><code>            return os.path.getmtime(path)</code></li>
<li class="missed"><code>        except OSError:</code></li>
<li class="missed"><code>            return 0</code></li>
<li class="missed"><code>        except NotImplementedError:</code></li>
<li class="missed"><code>            return None</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def open(self, mode=None):</code></li>
<li class="missed"><code>        if self.closed:</code></li>
<li class="missed"><code>            mode = mode or getattr(self, 'mode', None) or 'rb'</code></li>
<li class="missed"><code>            self.file = self.source_storage.open(self.name, mode)</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            self.seek(0)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # open() doesn't alter the file's contents, but it does reset the pointer.</code></li>
<li class="missed"><code>    open.alters_data = True</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class ThumbnailerFieldFile(FieldFile, Thumbnailer):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    A field file which provides some methods for generating (and returning)</code></li>
<li class="ignored"><code>    thumbnail images.</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    def __init__(self, *args, **kwargs):</code></li>
<li class="missed"><code>        super(ThumbnailerFieldFile, self).__init__(*args, **kwargs)</code></li>
<li class="missed"><code>        self.source_storage = self.field.storage</code></li>
<li class="missed"><code>        thumbnail_storage = getattr(self.field, 'thumbnail_storage', None)</code></li>
<li class="missed"><code>        if thumbnail_storage:</code></li>
<li class="missed"><code>            self.thumbnail_storage = thumbnail_storage</code></li>
<li class="missed"><code>        self.alias_target = self</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def save(self, name, content, *args, **kwargs):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Save the file, also saving a reference to the thumbnail cache Source</code></li>
<li class="ignored"><code>        model.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        super(ThumbnailerFieldFile, self).save(name, content, *args, **kwargs)</code></li>
<li class="missed"><code>        self.get_source_cache(create=True, update=True)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def delete(self, *args, **kwargs):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Delete the image, along with any generated thumbnails.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        source_cache = self.get_source_cache()</code></li>
<li class="ignored"><code>        # First, delete any related thumbnails.</code></li>
<li class="missed"><code>        self.delete_thumbnails(source_cache)</code></li>
<li class="ignored"><code>        # Next, delete the source image.</code></li>
<li class="missed"><code>        super(ThumbnailerFieldFile, self).delete(*args, **kwargs)</code></li>
<li class="ignored"><code>        # Finally, delete the source cache entry.</code></li>
<li class="missed"><code>        if source_cache:</code></li>
<li class="missed"><code>            source_cache.delete()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    delete.alters_data = True</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def delete_thumbnails(self, source_cache=None):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Delete any thumbnails generated from the source image.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        :arg source_cache: An optional argument only used for optimisation</code></li>
<li class="ignored"><code>          where the source cache instance is already known.</code></li>
<li class="ignored"><code>        :returns: The number of files deleted.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        source_cache = self.get_source_cache()</code></li>
<li class="missed"><code>        deleted = 0</code></li>
<li class="missed"><code>        if source_cache:</code></li>
<li class="missed"><code>            thumbnail_storage_hash = utils.get_storage_hash(</code></li>
<li class="ignored"><code>                                                    self.thumbnail_storage)</code></li>
<li class="missed"><code>            for thumbnail_cache in source_cache.thumbnails.all():</code></li>
<li class="ignored"><code>                # Only attempt to delete the file if it was stored using the</code></li>
<li class="ignored"><code>                # same storage as is currently used.</code></li>
<li class="missed"><code>                if thumbnail_cache.storage_hash == thumbnail_storage_hash:</code></li>
<li class="missed"><code>                    self.thumbnail_storage.delete(thumbnail_cache.name)</code></li>
<li class="ignored"><code>                    # Delete the cache thumbnail instance too.</code></li>
<li class="missed"><code>                    thumbnail_cache.delete()</code></li>
<li class="missed"><code>                    deleted += 1</code></li>
<li class="missed"><code>        return deleted</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    delete_thumbnails.alters_data = True</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_thumbnails(self, *args, **kwargs):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Return an iterator which returns ThumbnailFile instances.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        # First, delete any related thumbnails.</code></li>
<li class="missed"><code>        source_cache = self.get_source_cache()</code></li>
<li class="missed"><code>        if source_cache:</code></li>
<li class="missed"><code>            thumbnail_storage_hash = utils.get_storage_hash(</code></li>
<li class="ignored"><code>                                                    self.thumbnail_storage)</code></li>
<li class="missed"><code>            for thumbnail_cache in source_cache.thumbnails.all():</code></li>
<li class="ignored"><code>                # Only iterate files which are stored using the current</code></li>
<li class="ignored"><code>                # thumbnail storage.</code></li>
<li class="missed"><code>                if thumbnail_cache.storage_hash == thumbnail_storage_hash:</code></li>
<li class="missed"><code>                    yield ThumbnailFile(name=thumbnail_cache.name,</code></li>
<li class="ignored"><code>                                        storage=self.thumbnail_storage)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class ThumbnailerImageFieldFile(ImageFieldFile, ThumbnailerFieldFile):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    A field file which provides some methods for generating (and returning)</code></li>
<li class="ignored"><code>    thumbnail images.</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def save(self, name, content, *args, **kwargs):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Save the image.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        The image will be resized down using a ``ThumbnailField`` if</code></li>
<li class="ignored"><code>        ``resize_source`` (a dictionary of thumbnail options) is provided by</code></li>
<li class="ignored"><code>        the field.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        options = getattr(self.field, 'resize_source', None)</code></li>
<li class="missed"><code>        if options:</code></li>
<li class="missed"><code>            if not 'quality' in options:</code></li>
<li class="missed"><code>                options['quality'] = self.thumbnail_quality</code></li>
<li class="missed"><code>            content = Thumbnailer(content, name).generate_thumbnail(options)</code></li>
<li class="missed"><code>        super(ThumbnailerImageFieldFile, self).save(name, content, *args,</code></li>
<li class="ignored"><code>                                                    **kwargs)</code></li>
  </ol>
</div>

<div class="nav">
  <a href="easy_thumbnails.fields.html">easy_thumbnails.fields</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="easy_thumbnails.management.__init__.html">easy_thumbnails.management.__init__</a>
</div>

  </body>
</html>

