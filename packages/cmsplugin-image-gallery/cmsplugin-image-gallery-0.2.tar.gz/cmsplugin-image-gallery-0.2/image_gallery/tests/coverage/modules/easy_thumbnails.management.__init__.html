<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: easy_thumbnails.management</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="easy_thumbnails.files.html">easy_thumbnails.files</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="easy_thumbnails.management.commands.thumbnail_cleanup.html">easy_thumbnails.management.commands.thumbnail_cleanup</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">easy_thumbnails.management</span>:
    77 total statements,
    <span class="critical">0.0% covered</span>
  </h1>
  <p>Generated: Wed 2013-03-13 10:33 CET</p>
  <p>Source file: /media/Envs/Envs/filer-gallery/lib/python2.7/site-packages/easy_thumbnails/management/__init__.py</p>
  <p>
    Stats:
    <span class="executed">0 executed</span>,
    <span class="missed">74 missed</span>,
    <span class="excluded">3 excluded</span>,
    <span class="ignored">50 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="excluded"><code>import os</code></li>
<li class="excluded"><code>import re</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from easy_thumbnails.conf import settings</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>re_thumbnail_file = re.compile(r'(?P&lt;source_filename&gt;.+)_(?P&lt;x&gt;\d+)x(?P&lt;y&gt;\d+)'</code></li>
<li class="ignored"><code>                               r'(?:_(?P&lt;options&gt;\w+))?_q(?P&lt;quality&gt;\d+)'</code></li>
<li class="ignored"><code>                               r'(?:.[^.]+)?$')</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def all_thumbnails(path, recursive=True, prefix=None, subdir=None):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    Return a dictionary referencing all files which match the thumbnail format.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    Each key is a source image filename, relative to path.</code></li>
<li class="ignored"><code>    Each value is a list of dictionaries as explained in `thumbnails_for_file`.</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    if prefix is None:</code></li>
<li class="missed"><code>        prefix = settings.THUMBNAIL_PREFIX</code></li>
<li class="missed"><code>    if subdir is None:</code></li>
<li class="missed"><code>        subdir = settings.THUMBNAIL_SUBDIR</code></li>
<li class="missed"><code>    thumbnail_files = {}</code></li>
<li class="missed"><code>    if not path.endswith('/'):</code></li>
<li class="missed"><code>        path = '%s/' % path</code></li>
<li class="missed"><code>    len_path = len(path)</code></li>
<li class="missed"><code>    if recursive:</code></li>
<li class="missed"><code>        all = os.walk(path)</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        files = []</code></li>
<li class="missed"><code>        for file in os.listdir(path):</code></li>
<li class="missed"><code>            if os.path.isfile(os.path.join(path, file)):</code></li>
<li class="missed"><code>                files.append(file)</code></li>
<li class="missed"><code>        all = [(path, [], files)]</code></li>
<li class="missed"><code>    for dir_, subdirs, files in all:</code></li>
<li class="missed"><code>        rel_dir = dir_[len_path:]</code></li>
<li class="missed"><code>        for file in files:</code></li>
<li class="missed"><code>            thumb = re_thumbnail_file.match(file)</code></li>
<li class="missed"><code>            if not thumb:</code></li>
<li class="missed"><code>                continue</code></li>
<li class="missed"><code>            d = thumb.groupdict()</code></li>
<li class="missed"><code>            source_filename = d.pop('source_filename')</code></li>
<li class="missed"><code>            if prefix:</code></li>
<li class="missed"><code>                source_path, source_filename = os.path.split(source_filename)</code></li>
<li class="missed"><code>                if not source_filename.startswith(prefix):</code></li>
<li class="missed"><code>                    continue</code></li>
<li class="missed"><code>                source_filename = os.path.join(source_path,</code></li>
<li class="ignored"><code>                    source_filename[len(prefix):])</code></li>
<li class="missed"><code>            d['options'] = d['options'] and d['options'].split('_') or []</code></li>
<li class="missed"><code>            if subdir and rel_dir.endswith(subdir):</code></li>
<li class="missed"><code>                rel_dir = rel_dir[:-len(subdir)]</code></li>
<li class="ignored"><code>            # Corner-case bug: if the filename didn't have an extension but did</code></li>
<li class="ignored"><code>            # have an underscore, the last underscore will get converted to a</code></li>
<li class="ignored"><code>            # '.'.</code></li>
<li class="missed"><code>            m = re.match(r'(.*)_(.*)', source_filename)</code></li>
<li class="missed"><code>            if m:</code></li>
<li class="missed"><code>                source_filename = '%s.%s' % m.groups()</code></li>
<li class="missed"><code>            filename = os.path.join(rel_dir, source_filename)</code></li>
<li class="missed"><code>            thumbnail_file = thumbnail_files.setdefault(filename, [])</code></li>
<li class="missed"><code>            d['filename'] = os.path.join(dir_, file)</code></li>
<li class="missed"><code>            thumbnail_file.append(d)</code></li>
<li class="missed"><code>    return thumbnail_files</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def thumbnails_for_file(relative_source_path, root=None, basedir=None,</code></li>
<li class="ignored"><code>                        subdir=None, prefix=None):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    Return a list of dictionaries, one for each thumbnail belonging to the</code></li>
<li class="ignored"><code>    source image.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    The following list explains each key of the dictionary:</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>      `filename`  -- absolute thumbnail path</code></li>
<li class="ignored"><code>      `x` and `y` -- the size of the thumbnail</code></li>
<li class="ignored"><code>      `options`   -- list of options for this thumbnail</code></li>
<li class="ignored"><code>      `quality`   -- quality setting for this thumbnail</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    if root is None:</code></li>
<li class="missed"><code>        root = settings.MEDIA_ROOT</code></li>
<li class="missed"><code>    if prefix is None:</code></li>
<li class="missed"><code>        prefix = settings.THUMBNAIL_PREFIX</code></li>
<li class="missed"><code>    if subdir is None:</code></li>
<li class="missed"><code>        subdir = settings.THUMBNAIL_SUBDIR</code></li>
<li class="missed"><code>    if basedir is None:</code></li>
<li class="missed"><code>        basedir = settings.THUMBNAIL_BASEDIR</code></li>
<li class="missed"><code>    source_dir, filename = os.path.split(relative_source_path)</code></li>
<li class="missed"><code>    thumbs_path = os.path.join(root, basedir, source_dir, subdir)</code></li>
<li class="missed"><code>    if not os.path.isdir(thumbs_path):</code></li>
<li class="missed"><code>        return []</code></li>
<li class="missed"><code>    files = all_thumbnails(thumbs_path, recursive=False, prefix=prefix,</code></li>
<li class="ignored"><code>                           subdir='')</code></li>
<li class="missed"><code>    return files.get(filename, [])</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def delete_thumbnails(relative_source_path, root=None, basedir=None,</code></li>
<li class="ignored"><code>                      subdir=None, prefix=None):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    Delete all thumbnails for a source image.</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    thumbs = thumbnails_for_file(relative_source_path, root, basedir, subdir,</code></li>
<li class="ignored"><code>                                 prefix)</code></li>
<li class="missed"><code>    return _delete_using_thumbs_list(thumbs)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def _delete_using_thumbs_list(thumbs):</code></li>
<li class="missed"><code>    deleted = 0</code></li>
<li class="missed"><code>    for thumb_dict in thumbs:</code></li>
<li class="missed"><code>        filename = thumb_dict['filename']</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            os.remove(filename)</code></li>
<li class="missed"><code>        except:</code></li>
<li class="missed"><code>            pass</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            deleted += 1</code></li>
<li class="missed"><code>    return deleted</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def delete_all_thumbnails(path, recursive=True):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    Delete all files within a path which match the thumbnails pattern.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    By default, matching files from all sub-directories are also removed. To</code></li>
<li class="ignored"><code>    only remove from the path directory, set recursive=False.</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    total = 0</code></li>
<li class="missed"><code>    for thumbs in all_thumbnails(path, recursive=recursive).values():</code></li>
<li class="missed"><code>        total += _delete_using_thumbs_list(thumbs)</code></li>
<li class="missed"><code>    return total</code></li>
  </ol>
</div>

<div class="nav">
  <a href="easy_thumbnails.files.html">easy_thumbnails.files</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="easy_thumbnails.management.commands.thumbnail_cleanup.html">easy_thumbnails.management.commands.thumbnail_cleanup</a>
</div>

  </body>
</html>

