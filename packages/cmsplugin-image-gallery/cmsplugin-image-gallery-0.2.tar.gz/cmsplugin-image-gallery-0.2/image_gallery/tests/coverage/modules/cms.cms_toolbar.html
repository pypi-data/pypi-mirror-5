<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: cms.cms_toolbar</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="cms.cache.permissions.html">cms.cache.permissions</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="cms.conf.__init__.html">cms.conf.__init__</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">cms.cms_toolbar</span>:
    125 total statements,
    <span class="critical">0.0% covered</span>
  </h1>
  <p>Generated: Wed 2013-03-13 10:33 CET</p>
  <p>Source file: /media/Envs/Envs/filer-gallery/lib/python2.7/site-packages/cms/cms_toolbar.py</p>
  <p>
    Stats:
    <span class="executed">0 executed</span>,
    <span class="missed">111 missed</span>,
    <span class="excluded">14 excluded</span>,
    <span class="ignored">113 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="ignored"><code># -*- coding: utf-8 -*-</code></li>
<li class="excluded"><code>from cms.toolbar.base import Toolbar</code></li>
<li class="excluded"><code>from cms.toolbar.constants import LEFT, RIGHT</code></li>
<li class="excluded"><code>from cms.toolbar.items import (Anchor, Switcher, TemplateHTML, ListItem, List,</code></li>
<li class="ignored"><code>    GetButton)</code></li>
<li class="excluded"><code>from cms.utils import cms_static_url</code></li>
<li class="excluded"><code>from cms.utils.moderator import page_moderator_state, I_APPROVE</code></li>
<li class="excluded"><code>from django import forms</code></li>
<li class="excluded"><code>from django.conf import settings</code></li>
<li class="excluded"><code>from django.contrib.auth import authenticate, login, logout</code></li>
<li class="excluded"><code>from django.core.urlresolvers import reverse</code></li>
<li class="excluded"><code>from django.http import HttpResponseRedirect</code></li>
<li class="excluded"><code>from django.utils.translation import ugettext_lazy as _</code></li>
<li class="excluded"><code>import urllib</code></li>
<li class="excluded"><code>from utils.permissions import has_page_change_permission, has_any_page_change_permissions</code></li>
<li class="excluded"><code>from django.conf import settings</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def _get_page_admin_url(context, toolbar, **kwargs):</code></li>
<li class="missed"><code>    return reverse('admin:cms_page_change', args=(toolbar.request.current_page.pk,))</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def _get_page_history_url(context, toolbar, **kwargs):</code></li>
<li class="missed"><code>    return reverse('admin:cms_page_history', args=(toolbar.request.current_page.pk,))</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def _get_add_child_url(context, toolbar, **kwargs):</code></li>
<li class="missed"><code>    data = {</code></li>
<li class="ignored"><code>        'position': 'last-child',</code></li>
<li class="ignored"><code>        'target': toolbar.request.current_page.pk,</code></li>
<li class="ignored"><code>    }</code></li>
<li class="missed"><code>    args = urllib.urlencode(data)</code></li>
<li class="missed"><code>    return '%s?%s' % (reverse('admin:cms_page_add'), args)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def _get_add_sibling_url(context, toolbar, **kwargs):</code></li>
<li class="missed"><code>    data = {</code></li>
<li class="ignored"><code>        'position': 'last-child',</code></li>
<li class="ignored"><code>    }</code></li>
<li class="missed"><code>    if toolbar.request.current_page.parent_id:</code></li>
<li class="missed"><code>        data['target'] = toolbar.request.current_page.parent_id</code></li>
<li class="missed"><code>    args = urllib.urlencode(data)</code></li>
<li class="missed"><code>    return '%s?%s' % (reverse('admin:cms_page_add'), args)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def _get_delete_url(context, toolbar, **kwargs):</code></li>
<li class="missed"><code>    return reverse('admin:cms_page_delete', args=(toolbar.request.current_page.pk,))</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def _get_approve_url(context, toolbar, **kwargs):</code></li>
<li class="missed"><code>    return reverse('admin:cms_page_approve_page', args=(toolbar.request.current_page.pk,))</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def _get_publish_url(context, toolbar, **kwargs):</code></li>
<li class="missed"><code>    return reverse('admin:cms_page_publish_page', args=(toolbar.request.current_page.pk,))</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class CMSToolbarLoginForm(forms.Form):</code></li>
<li class="missed"><code>    cms_username = forms.CharField()</code></li>
<li class="missed"><code>    cms_password = forms.CharField()</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class CMSToolbar(Toolbar):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    The default CMS Toolbar</code></li>
<li class="ignored"><code>    """</code></li>
<li class="missed"><code>    def __init__(self, request):</code></li>
<li class="missed"><code>        super(CMSToolbar, self).__init__(request)</code></li>
<li class="missed"><code>        self.init()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def init(self):</code></li>
<li class="missed"><code>        self.is_staff = self.request.user.is_staff</code></li>
<li class="missed"><code>        self.can_change = (self.request.current_page and</code></li>
<li class="ignored"><code>                           self.request.current_page.has_change_permission(self.request))</code></li>
<li class="missed"><code>        self.edit_mode_switcher = Switcher(LEFT, 'editmode', 'edit', 'edit-off',</code></li>
<li class="ignored"><code>                                           _('Edit mode'))</code></li>
<li class="missed"><code>        self.edit_mode = self.is_staff and self.edit_mode_switcher.get_state(self.request)</code></li>
<li class="missed"><code>        self.show_toolbar = self.is_staff or self.edit_mode_switcher.get_state(self.request)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_items(self, context, **kwargs):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Get the CMS items on the toolbar</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        items = [</code></li>
<li class="ignored"><code>            Anchor(LEFT, 'logo', _('django CMS'), 'https://www.django-cms.org'),</code></li>
<li class="ignored"><code>        ]</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        self.page_states = []</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        if self.is_staff:</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            items.append(</code></li>
<li class="ignored"><code>                self.edit_mode_switcher</code></li>
<li class="ignored"><code>            )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            if self.request.current_page:</code></li>
<li class="missed"><code>                states = self.request.current_page.last_page_states()</code></li>
<li class="missed"><code>                has_states = states.exists()</code></li>
<li class="missed"><code>                self.page_states = states</code></li>
<li class="missed"><code>                if has_states:</code></li>
<li class="missed"><code>                    items.append(</code></li>
<li class="ignored"><code>                        TemplateHTML(LEFT, 'status',</code></li>
<li class="ignored"><code>                                     'cms/toolbar/items/status.html')</code></li>
<li class="ignored"><code>                    )</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>                # publish button</code></li>
<li class="missed"><code>                if self.edit_mode and settings.CMS_MODERATOR:</code></li>
<li class="missed"><code>                    moderator_state = page_moderator_state(self.request, self.request.current_page)</code></li>
<li class="missed"><code>                    should_approve = moderator_state['state'] &gt;= I_APPROVE</code></li>
<li class="missed"><code>                    has_perms = self.request.current_page.has_moderate_permission(self.request)</code></li>
<li class="missed"><code>                    if should_approve and has_perms:</code></li>
<li class="missed"><code>                        label = moderator_state['label']</code></li>
<li class="missed"><code>                        urlgetter = _get_approve_url</code></li>
<li class="missed"><code>                    elif has_perms:</code></li>
<li class="missed"><code>                        label = _("Publish")</code></li>
<li class="missed"><code>                        urlgetter = _get_publish_url</code></li>
<li class="ignored"><code>                    else:</code></li>
<li class="missed"><code>                        urlgetter = _get_approve_url</code></li>
<li class="missed"><code>                        label = _("Request Approval")</code></li>
<li class="missed"><code>                    items.append(</code></li>
<li class="ignored"><code>                        GetButton(RIGHT, 'moderator', label, urlgetter)</code></li>
<li class="ignored"><code>                    )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>                has_global_current_page_change_permission = False</code></li>
<li class="missed"><code>                if settings.CMS_PERMISSION:</code></li>
<li class="missed"><code>                    has_global_current_page_change_permission = has_page_change_permission(self.request)</code></li>
<li class="missed"><code>                has_current_page_change_permission = self.request.current_page.has_change_permission(self.request)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>                # The 'templates' Menu</code></li>
<li class="missed"><code>                if has_global_current_page_change_permission or has_current_page_change_permission:</code></li>
<li class="missed"><code>                    items.append(self.get_template_menu(context, self.can_change, self.is_staff))</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>                # The 'page' Menu</code></li>
<li class="missed"><code>                items.append(self.get_page_menu(context, self.can_change, self.is_staff))</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # The 'Admin' Menu</code></li>
<li class="missed"><code>            items.append(self.get_admin_menu(context, self.can_change, self.is_staff))</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>            items.append(</code></li>
<li class="ignored"><code>                GetButton(RIGHT, 'logout', _('Logout'), '?cms-toolbar-logout',</code></li>
<li class="ignored"><code>                          cms_static_url('images/toolbar/icons/icon_lock.png'))</code></li>
<li class="ignored"><code>            )</code></li>
<li class="missed"><code>        elif not self.request.user.is_authenticated():</code></li>
<li class="missed"><code>            items.append(</code></li>
<li class="ignored"><code>                TemplateHTML(LEFT, 'login', 'cms/toolbar/items/login.html')</code></li>
<li class="ignored"><code>            )</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            items.append(</code></li>
<li class="ignored"><code>                GetButton(RIGHT, 'logout', _('Logout'), '?cms-toolbar-logout',</code></li>
<li class="ignored"><code>                          cms_static_url('images/toolbar/icons/icon_lock.png'))</code></li>
<li class="ignored"><code>            )</code></li>
<li class="missed"><code>        return items</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_template_menu(self, context, can_change, is_staff):</code></li>
<li class="missed"><code>        menu_items = []</code></li>
<li class="missed"><code>        url = reverse('admin:cms_page_change_template', args=(self.request.current_page.pk,))</code></li>
<li class="missed"><code>        for path, name in settings.CMS_TEMPLATES:</code></li>
<li class="missed"><code>            args = urllib.urlencode({'template': path})</code></li>
<li class="missed"><code>            css = 'template'</code></li>
<li class="missed"><code>            if self.request.current_page.get_template() == path:</code></li>
<li class="missed"><code>                css += ' active'</code></li>
<li class="missed"><code>            menu_items.append(</code></li>
<li class="ignored"><code>                ListItem(css, name, '%s?%s' % (url, args), 'POST'),</code></li>
<li class="ignored"><code>            )</code></li>
<li class="missed"><code>        return List(RIGHT, 'templates', _('Template'),</code></li>
<li class="ignored"><code>                    '', items=menu_items)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_page_menu(self, context, can_change, is_staff):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Builds the 'page menu'</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        menu_items = [</code></li>
<li class="ignored"><code>            ListItem('overview', _('Move/add Pages'),</code></li>
<li class="ignored"><code>                     reverse('admin:cms_page_changelist'),</code></li>
<li class="ignored"><code>                     icon=cms_static_url('images/toolbar/icons/icon_sitemap.png')),</code></li>
<li class="ignored"><code>        ]</code></li>
<li class="missed"><code>        menu_items.append(</code></li>
<li class="ignored"><code>            ListItem('addchild', _('Add child page'),</code></li>
<li class="ignored"><code>                     _get_add_child_url,</code></li>
<li class="ignored"><code>                     icon=cms_static_url('images/toolbar/icons/icon_child.png'))</code></li>
<li class="ignored"><code>        )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        menu_items.append(</code></li>
<li class="ignored"><code>            ListItem('addsibling', _('Add sibling page'),</code></li>
<li class="ignored"><code>                     _get_add_sibling_url,</code></li>
<li class="ignored"><code>                     icon=cms_static_url('images/toolbar/icons/icon_sibling.png'))</code></li>
<li class="ignored"><code>        )</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        menu_items.append(</code></li>
<li class="ignored"><code>            ListItem('delete', _('Delete Page'), _get_delete_url,</code></li>
<li class="ignored"><code>                     icon=cms_static_url('images/toolbar/icons/icon_delete.png'))</code></li>
<li class="ignored"><code>        )</code></li>
<li class="missed"><code>        return List(RIGHT, 'page', _('Page'),</code></li>
<li class="ignored"><code>                    cms_static_url('images/toolbar/icons/icon_page.png'),</code></li>
<li class="ignored"><code>                    items=menu_items)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_admin_menu(self, context, can_change, is_staff):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Builds the 'admin menu' (the one with the cogwheel)</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        admin_items = [</code></li>
<li class="ignored"><code>            ListItem('admin', _('Site Administration'),</code></li>
<li class="ignored"><code>                     reverse('admin:index'),</code></li>
<li class="ignored"><code>                     icon=cms_static_url('images/toolbar/icons/icon_admin.png')),</code></li>
<li class="ignored"><code>        ]</code></li>
<li class="missed"><code>        if can_change:</code></li>
<li class="missed"><code>            admin_items.append(</code></li>
<li class="ignored"><code>                ListItem('settings', _('Page Settings'),</code></li>
<li class="ignored"><code>                         _get_page_admin_url,</code></li>
<li class="ignored"><code>                         icon=cms_static_url('images/toolbar/icons/icon_page.png'))</code></li>
<li class="ignored"><code>            )</code></li>
<li class="missed"><code>            if 'reversion' in settings.INSTALLED_APPS:</code></li>
<li class="missed"><code>                admin_items.append(</code></li>
<li class="ignored"><code>                    ListItem('history', _('View History'),</code></li>
<li class="ignored"><code>                             _get_page_history_url,</code></li>
<li class="ignored"><code>                             icon=cms_static_url('images/toolbar/icons/icon_history.png'))</code></li>
<li class="ignored"><code>                )</code></li>
<li class="missed"><code>        return List(RIGHT, 'admin', _('Admin'),</code></li>
<li class="ignored"><code>                    cms_static_url('images/toolbar/icons/icon_admin.png'),</code></li>
<li class="ignored"><code>                    items=admin_items)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def request_hook(self):</code></li>
<li class="missed"><code>        if self.request.method != 'POST':</code></li>
<li class="missed"><code>            return self._request_hook_get()</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            return self._request_hook_post()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _request_hook_get(self):</code></li>
<li class="missed"><code>        if 'cms-toolbar-logout' in self.request.GET:</code></li>
<li class="missed"><code>            logout(self.request)</code></li>
<li class="missed"><code>            return HttpResponseRedirect(self.request.path)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _request_hook_post(self):</code></li>
<li class="ignored"><code>        # login hook</code></li>
<li class="missed"><code>        if 'cms-toolbar-login' in self.request.GET:</code></li>
<li class="missed"><code>            login_form = CMSToolbarLoginForm(self.request.POST)</code></li>
<li class="missed"><code>            if login_form.is_valid():</code></li>
<li class="missed"><code>                username = login_form.cleaned_data['cms_username']</code></li>
<li class="missed"><code>                password = login_form.cleaned_data['cms_password']</code></li>
<li class="missed"><code>                user = authenticate(username=username, password=password)</code></li>
<li class="missed"><code>                if user:</code></li>
<li class="missed"><code>                    login(self.request, user)</code></li>
<li class="missed"><code>                    self.init()</code></li>
  </ol>
</div>

<div class="nav">
  <a href="cms.cache.permissions.html">cms.cache.permissions</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="cms.conf.__init__.html">cms.conf.__init__</a>
</div>

  </body>
</html>

