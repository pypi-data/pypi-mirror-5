<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: cms.test_utils.testcases</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="cms.test_utils.runners.html">cms.test_utils.runners</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="cms.test_utils.tmpdir.html">cms.test_utils.tmpdir</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">cms.test_utils.testcases</span>:
    190 total statements,
    <span class="critical">0.0% covered</span>
  </h1>
  <p>Generated: Wed 2013-03-13 10:33 CET</p>
  <p>Source file: /media/Envs/Envs/filer-gallery/lib/python2.7/site-packages/cms/test_utils/testcases.py</p>
  <p>
    Stats:
    <span class="executed">0 executed</span>,
    <span class="missed">175 missed</span>,
    <span class="excluded">15 excluded</span>,
    <span class="ignored">103 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="ignored"><code># -*- coding: utf-8 -*-</code></li>
<li class="excluded"><code>from cms.models import Page</code></li>
<li class="excluded"><code>from cms.test_utils.util.context_managers import (UserLoginContext,</code></li>
<li class="ignored"><code>    SettingsOverride)</code></li>
<li class="excluded"><code>from django.conf import settings</code></li>
<li class="excluded"><code>from django.contrib.auth.models import User, AnonymousUser</code></li>
<li class="excluded"><code>from django.core.exceptions import ObjectDoesNotExist</code></li>
<li class="excluded"><code>from django.core.urlresolvers import reverse</code></li>
<li class="excluded"><code>from django.template.context import Context</code></li>
<li class="excluded"><code>from django.test import testcases</code></li>
<li class="excluded"><code>from django.test.client import Client, RequestFactory</code></li>
<li class="excluded"><code>from menus.menu_pool import menu_pool</code></li>
<li class="excluded"><code>from urlparse import urljoin</code></li>
<li class="excluded"><code>import sys</code></li>
<li class="excluded"><code>import urllib</code></li>
<li class="excluded"><code>import warnings</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>URL_CMS_PAGE = "/en/admin/cms/page/"</code></li>
<li class="missed"><code>URL_CMS_PAGE_ADD = urljoin(URL_CMS_PAGE, "add/")</code></li>
<li class="missed"><code>URL_CMS_PAGE_CHANGE = urljoin(URL_CMS_PAGE, "%d/")</code></li>
<li class="missed"><code>URL_CMS_PAGE_DELETE = urljoin(URL_CMS_PAGE_CHANGE, "delete/")</code></li>
<li class="missed"><code>URL_CMS_PLUGIN_ADD = urljoin(URL_CMS_PAGE_CHANGE, "add-plugin/")</code></li>
<li class="missed"><code>URL_CMS_PLUGIN_EDIT = urljoin(URL_CMS_PAGE_CHANGE, "edit-plugin/")</code></li>
<li class="missed"><code>URL_CMS_PLUGIN_REMOVE = urljoin(URL_CMS_PAGE_CHANGE, "remove-plugin/")</code></li>
<li class="missed"><code>URL_CMS_TRANSLATION_DELETE = urljoin(URL_CMS_PAGE_CHANGE, "delete-translation/")</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class _Warning(object):</code></li>
<li class="missed"><code>    def __init__(self, message, category, filename, lineno):</code></li>
<li class="missed"><code>        self.message = message</code></li>
<li class="missed"><code>        self.category = category</code></li>
<li class="missed"><code>        self.filename = filename</code></li>
<li class="missed"><code>        self.lineno = lineno</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>def _collectWarnings(observeWarning, f, *args, **kwargs):</code></li>
<li class="missed"><code>    def showWarning(message, category, filename, lineno, file=None, line=None):</code></li>
<li class="missed"><code>        assert isinstance(message, Warning)</code></li>
<li class="missed"><code>        observeWarning(_Warning(</code></li>
<li class="ignored"><code>                message.args[0], category, filename, lineno))</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # Disable the per-module cache for every module otherwise if the warning</code></li>
<li class="ignored"><code>    # which the caller is expecting us to collect was already emitted it won't</code></li>
<li class="ignored"><code>    # be re-emitted by the call to f which happens below.</code></li>
<li class="missed"><code>    for v in sys.modules.itervalues():</code></li>
<li class="missed"><code>        if v is not None:</code></li>
<li class="missed"><code>            try:</code></li>
<li class="missed"><code>                v.__warningregistry__ = None</code></li>
<li class="missed"><code>            except:</code></li>
<li class="ignored"><code>                # Don't specify a particular exception type to handle in case</code></li>
<li class="ignored"><code>                # some wacky object raises some wacky exception in response to</code></li>
<li class="ignored"><code>                # the setattr attempt.</code></li>
<li class="missed"><code>                pass</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    origFilters = warnings.filters[:]</code></li>
<li class="missed"><code>    origShow = warnings.showwarning</code></li>
<li class="missed"><code>    warnings.simplefilter('always')</code></li>
<li class="missed"><code>    try:</code></li>
<li class="missed"><code>        warnings.showwarning = showWarning</code></li>
<li class="missed"><code>        result = f(*args, **kwargs)</code></li>
<li class="ignored"><code>    finally:</code></li>
<li class="missed"><code>        warnings.filters[:] = origFilters</code></li>
<li class="missed"><code>        warnings.showwarning = origShow</code></li>
<li class="missed"><code>    return result</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class CMSTestCase(testcases.TestCase):</code></li>
<li class="missed"><code>    counter = 1</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _fixture_setup(self):</code></li>
<li class="missed"><code>        super(CMSTestCase, self)._fixture_setup()</code></li>
<li class="missed"><code>        self.create_fixtures()</code></li>
<li class="missed"><code>        self.client = Client()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def create_fixtures(self):</code></li>
<li class="missed"><code>        pass</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _post_teardown(self):</code></li>
<li class="ignored"><code>        # Needed to clean the menu keys cache, see menu.menu_pool.clear()</code></li>
<li class="missed"><code>        menu_pool.clear()</code></li>
<li class="missed"><code>        super(CMSTestCase, self)._post_teardown()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def login_user_context(self, user):</code></li>
<li class="missed"><code>        return UserLoginContext(self, user)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_superuser(self):</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            admin = User.objects.get(username="admin")</code></li>
<li class="missed"><code>        except User.DoesNotExist:</code></li>
<li class="missed"><code>            admin = User(username="admin", is_staff=True, is_active=True, is_superuser=True)</code></li>
<li class="missed"><code>            admin.set_password("admin")</code></li>
<li class="missed"><code>            admin.save()</code></li>
<li class="missed"><code>        return admin</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_staff_user_with_no_permissions(self):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Used in security tests</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        staff = User(username="staff", is_staff=True, is_active=True)</code></li>
<li class="missed"><code>        staff.set_password("staff")</code></li>
<li class="missed"><code>        staff.save()</code></li>
<li class="missed"><code>        return staff</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_new_page_data(self, parent_id=''):</code></li>
<li class="missed"><code>        page_data = {</code></li>
<li class="ignored"><code>            'title': 'test page %d' % self.counter,</code></li>
<li class="ignored"><code>            'slug': 'test-page-%d' % self.counter,</code></li>
<li class="ignored"><code>            'language': settings.LANGUAGES[0][0],</code></li>
<li class="ignored"><code>            'template': 'nav_playground.html',</code></li>
<li class="ignored"><code>            'parent': parent_id,</code></li>
<li class="ignored"><code>            'site': 1,</code></li>
<li class="ignored"><code>        }</code></li>
<li class="ignored"><code>        # required only if user haves can_change_permission</code></li>
<li class="missed"><code>        page_data['pagepermission_set-TOTAL_FORMS'] = 0</code></li>
<li class="missed"><code>        page_data['pagepermission_set-INITIAL_FORMS'] = 0</code></li>
<li class="missed"><code>        page_data['pagepermission_set-MAX_NUM_FORMS'] = 0</code></li>
<li class="missed"><code>        page_data['pagepermission_set-2-TOTAL_FORMS'] = 0</code></li>
<li class="missed"><code>        page_data['pagepermission_set-2-INITIAL_FORMS'] = 0</code></li>
<li class="missed"><code>        page_data['pagepermission_set-2-MAX_NUM_FORMS'] = 0</code></li>
<li class="missed"><code>        self.counter = self.counter + 1</code></li>
<li class="missed"><code>        return page_data</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def print_page_structure(self, qs):</code></li>
<li class="ignored"><code>        """Just a helper to see the page struct.</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        for page in qs.order_by('tree_id', 'lft'):</code></li>
<li class="missed"><code>            ident = "  " * page.level</code></li>
<li class="missed"><code>            print "%s%s (%s), lft: %s, rght: %s, tree_id: %s" % (ident, page,</code></li>
<li class="ignored"><code>                                    page.pk, page.lft, page.rght, page.tree_id)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def print_node_structure(self, nodes, *extra):</code></li>
<li class="missed"><code>        def _rec(nodes, level=0):</code></li>
<li class="missed"><code>            ident = level * '  '</code></li>
<li class="missed"><code>            for node in nodes:</code></li>
<li class="missed"><code>                raw_attrs = [(bit, getattr(node, bit, node.attr.get(bit, "unknown"))) for bit in extra]</code></li>
<li class="missed"><code>                attrs = ', '.join(['%s: %r' % data for data in raw_attrs])</code></li>
<li class="missed"><code>                print "%s%s: %s" % (ident, node.title, attrs)</code></li>
<li class="missed"><code>                _rec(node.children, level + 1)</code></li>
<li class="missed"><code>        _rec(nodes)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def assertObjectExist(self, qs, **filter):</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            return qs.get(**filter)</code></li>
<li class="missed"><code>        except ObjectDoesNotExist:</code></li>
<li class="missed"><code>            pass</code></li>
<li class="missed"><code>        raise self.failureException, "ObjectDoesNotExist raised"</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def assertObjectDoesNotExist(self, qs, **filter):</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            qs.get(**filter)</code></li>
<li class="missed"><code>        except ObjectDoesNotExist:</code></li>
<li class="missed"><code>            return</code></li>
<li class="missed"><code>        raise self.failureException, "ObjectDoesNotExist not raised"</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def copy_page(self, page, target_page):</code></li>
<li class="excluded"><code>        from cms.utils.page import get_available_slug</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        data = {</code></li>
<li class="ignored"><code>            'position': 'last-child',</code></li>
<li class="ignored"><code>            'target': target_page.pk,</code></li>
<li class="ignored"><code>            'site': 1,</code></li>
<li class="ignored"><code>            'copy_permissions': 'on',</code></li>
<li class="ignored"><code>            'copy_moderation': 'on',</code></li>
<li class="ignored"><code>        }</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        response = self.client.post(URL_CMS_PAGE + "%d/copy-page/" % page.pk, data)</code></li>
<li class="missed"><code>        self.assertEquals(response.status_code, 200)</code></li>
<li class="ignored"><code>        # Altered to reflect the new django-js jsonified response messages</code></li>
<li class="missed"><code>        self.assertEquals(response.content, '{"status": 200, "content": "ok"}')</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        title = page.title_set.all()[0]</code></li>
<li class="missed"><code>        copied_slug = get_available_slug(title)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        copied_page = self.assertObjectExist(Page.objects, title_set__slug=copied_slug, parent=target_page)</code></li>
<li class="missed"><code>        return copied_page</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def move_page(self, page, target_page, position="first-child"):</code></li>
<li class="missed"><code>        page.move_page(target_page, position)</code></li>
<li class="missed"><code>        return self.reload_page(page)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def reload_page(self, page):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Returns a fresh instance of the page from the database</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        return self.reload(page)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def reload(self, obj):</code></li>
<li class="missed"><code>        return obj.__class__.objects.get(pk=obj.pk)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_pages_root(self):</code></li>
<li class="missed"><code>        return urllib.unquote(reverse("pages-root"))</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_context(self, path=None):</code></li>
<li class="missed"><code>        if not path:</code></li>
<li class="missed"><code>            path = self.get_pages_root()</code></li>
<li class="missed"><code>        context = {}</code></li>
<li class="missed"><code>        request = self.get_request(path)</code></li>
<li class="missed"><code>        context['request'] = request</code></li>
<li class="missed"><code>        return Context(context)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def get_request(self, path=None, language=None, post_data=None, enforce_csrf_checks=False):</code></li>
<li class="missed"><code>        factory = RequestFactory()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        if not path:</code></li>
<li class="missed"><code>            path = self.get_pages_root()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        if not language:</code></li>
<li class="missed"><code>            language = settings.LANGUAGES[0][0]</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        if post_data:</code></li>
<li class="missed"><code>            request = factory.post(path, post_data)</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            request = factory.get(path)</code></li>
<li class="missed"><code>        request.session = self.client.session</code></li>
<li class="missed"><code>        request.user = getattr(self, 'user', AnonymousUser())</code></li>
<li class="missed"><code>        request.LANGUAGE_CODE = language</code></li>
<li class="missed"><code>        request._dont_enforce_csrf_checks = not enforce_csrf_checks</code></li>
<li class="missed"><code>        return request</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def check_published_page_attributes(self, page):</code></li>
<li class="missed"><code>        public_page = page.publisher_public</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        if page.parent:</code></li>
<li class="missed"><code>            self.assertEqual(page.parent_id, public_page.parent.publisher_draft.id)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        self.assertEqual(page.level, public_page.level)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        # TODO: add check for siblings</code></li>
<li class="missed"><code>        draft_siblings = list(page.get_siblings(True).filter(</code></li>
<li class="ignored"><code>                publisher_is_draft=True</code></li>
<li class="ignored"><code>            ).order_by('tree_id', 'parent', 'lft'))</code></li>
<li class="missed"><code>        public_siblings = list(public_page.get_siblings(True).filter(</code></li>
<li class="ignored"><code>                publisher_is_draft=False</code></li>
<li class="ignored"><code>            ).order_by('tree_id', 'parent', 'lft'))</code></li>
<li class="missed"><code>        skip = 0</code></li>
<li class="missed"><code>        for i, sibling in enumerate(draft_siblings):</code></li>
<li class="missed"><code>            if not sibling.publisher_public_id:</code></li>
<li class="missed"><code>                skip += 1</code></li>
<li class="missed"><code>                continue</code></li>
<li class="missed"><code>            self.assertEqual(sibling.id,</code></li>
<li class="ignored"><code>                public_siblings[i - skip].publisher_draft.id)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def request_moderation(self, page, level):</code></li>
<li class="ignored"><code>        """Assign current logged in user to the moderators / change moderation</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        Args:</code></li>
<li class="ignored"><code>            page: Page on which moderation should be changed</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            level &lt;0, 7&gt;: Level of moderation,</code></li>
<li class="ignored"><code>                1 - moderate page</code></li>
<li class="ignored"><code>                2 - moderate children</code></li>
<li class="ignored"><code>                4 - moderate descendants</code></li>
<li class="ignored"><code>                + combinations</code></li>
<li class="ignored"><code>        """</code></li>
<li class="missed"><code>        response = self.client.post("/admin/cms/page/%d/change-moderation/" % page.id, {'moderate': level})</code></li>
<li class="missed"><code>        self.assertEquals(response.status_code, 200)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def failUnlessWarns(self, category, message, f, *args, **kwargs):</code></li>
<li class="missed"><code>        warningsShown = []</code></li>
<li class="missed"><code>        result = _collectWarnings(warningsShown.append, f, *args, **kwargs)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        if not warningsShown:</code></li>
<li class="missed"><code>            self.fail("No warnings emitted")</code></li>
<li class="missed"><code>        first = warningsShown[0]</code></li>
<li class="missed"><code>        for other in warningsShown[1:]:</code></li>
<li class="missed"><code>            if ((other.message, other.category)</code></li>
<li class="ignored"><code>                != (first.message, first.category)):</code></li>
<li class="missed"><code>                self.fail("Can't handle different warnings")</code></li>
<li class="missed"><code>        self.assertEqual(first.message, message)</code></li>
<li class="missed"><code>        self.assertTrue(first.category is category)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>        return result</code></li>
<li class="missed"><code>    assertWarns = failUnlessWarns</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>class SettingsOverrideTestCase(CMSTestCase):</code></li>
<li class="missed"><code>    settings_overrides = {}</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _pre_setup(self):</code></li>
<li class="missed"><code>        self._enter_settings_override()</code></li>
<li class="missed"><code>        super(SettingsOverrideTestCase, self)._pre_setup()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _enter_settings_override(self):</code></li>
<li class="missed"><code>        self._settings_ctx_manager = SettingsOverride(**self.settings_overrides)</code></li>
<li class="missed"><code>        self._settings_ctx_manager.__enter__()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _post_teardown(self):</code></li>
<li class="missed"><code>        super(SettingsOverrideTestCase, self)._post_teardown()</code></li>
<li class="missed"><code>        self._exit_settings_override()</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def _exit_settings_override(self):</code></li>
<li class="missed"><code>        self._settings_ctx_manager.__exit__(None, None, None)</code></li>
  </ol>
</div>

<div class="nav">
  <a href="cms.test_utils.runners.html">cms.test_utils.runners</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="cms.test_utils.tmpdir.html">cms.test_utils.tmpdir</a>
</div>

  </body>
</html>

