<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Parsley Tutorial Part I: Basics and Syntax &mdash; Parsley 1.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Parsley 1.1 documentation" href="index.html" />
    <link rel="next" title="Parsley Tutorial Part II: Parsing Structured Data" href="tutorial2.html" />
    <link rel="prev" title="Welcome to Parsley’s documentation!" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="tutorial2.html" title="Parsley Tutorial Part II: Parsing Structured Data"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to Parsley’s documentation!"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Parsley 1.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="parsley-tutorial-part-i-basics-and-syntax">
<h1>Parsley Tutorial Part I: Basics and Syntax<a class="headerlink" href="#parsley-tutorial-part-i-basics-and-syntax" title="Permalink to this headline">¶</a></h1>
<div class="section" id="from-regular-expressions-to-grammars">
<h2>From Regular Expressions To Grammars<a class="headerlink" href="#from-regular-expressions-to-grammars" title="Permalink to this headline">¶</a></h2>
<p>Parsley is a pattern matching and parsing tool for Python programmers.</p>
<p>Most Python programmers are familiar with regular expressions, as
provided by Python&#8217;s <cite>re</cite> module. To use it, you provide a string that
describes the pattern you want to match, and your input.</p>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">re</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;a(b|c)d+e&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;abddde&quot;</span><span class="p">)</span>
<span class="go">&lt;_sre.SRE_Match object at 0x7f587af54af8&gt;</span>
</pre></div>
</div>
<p>You can do exactly the same sort of thing in Parsley:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">parsley</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">parsley</span><span class="o">.</span><span class="n">makeGrammar</span><span class="p">(</span><span class="s">&quot;foo = &#39;a&#39; (&#39;b&#39; | &#39;c&#39;) &#39;d&#39;+ &#39;e&#39;&quot;</span><span class="p">,</span> <span class="p">{})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="p">(</span><span class="s">&quot;abdde&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>
<span class="go">&#39;e&#39;</span>
</pre></div>
</div>
<p>From this small example, a couple differences between regular
expressions and Parsley grammars can be seen:</p>
<div class="section" id="parsley-grammars-have-named-rules">
<h3>Parsley Grammars Have Named Rules<a class="headerlink" href="#parsley-grammars-have-named-rules" title="Permalink to this headline">¶</a></h3>
<p>A Parsley grammar can have many rules, and each has a name. The
example above has a single rule named <cite>foo</cite>. Rules can call each
other; calling rules in Parsley works like calling functions in
Python. Here is another way to write the grammar above:</p>
<div class="highlight-python"><pre>foo = 'a' baz 'd'+ 'e'
baz = 'b' | 'c'</pre>
</div>
</div>
<div class="section" id="parsley-grammars-are-expressions">
<h3>Parsley Grammars Are Expressions<a class="headerlink" href="#parsley-grammars-are-expressions" title="Permalink to this headline">¶</a></h3>
<p>Calling <cite>match</cite> for a regular expression returns a match object if the
match succeeds or None if it fails. Parsley parsers return the value
of last expression in the rule. Behind the scenes, Parsley turns each
rule in your grammar into Python methods. In pseudo-Python code, it
looks something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">match</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">baz</span><span class="p">()</span>
    <span class="n">match_one_or_more</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">match</span><span class="p">(</span><span class="s">&#39;e&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">baz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">match</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">match</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The value of the last expression in the rule is what the rule
returns. This is why our example returns &#8216;e&#8217;.</p>
<p>The similarities to regular expressions pretty much end here,
though. Having multiple named rules composed of expressions makes for
a much more powerful tool, and now we&#8217;re going to look at some more
features that go even further.</p>
</div>
<div class="section" id="rules-can-embed-python-expressions">
<h3>Rules Can Embed Python Expressions<a class="headerlink" href="#rules-can-embed-python-expressions" title="Permalink to this headline">¶</a></h3>
<p>Since these rules just turn into Python code eventually, we can stick
some Python code into them ourselves. This is particularly useful for
changing the return value of a rule. The Parsley expression for this
is <cite>-&gt;</cite>. We can also bind the results of expressions to variable names
and use them in Python code. So things like this are possible:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">parsley</span><span class="o">.</span><span class="n">makeGrammar</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">foo = &#39;a&#39;:one baz:two &#39;d&#39;+ &#39;e&#39; -&gt; (one, two)</span>
<span class="s">baz = &#39;b&#39; | &#39;c&#39;</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">{})</span>
<span class="k">print</span> <span class="n">x</span><span class="p">(</span><span class="s">&quot;abdde&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Literal match expressions like <cite>&#8216;a&#8217;</cite> return the character they
match. Using a colon and a variable name after an expression is like
assignment in Python. As a result, we can use those names in a Python
expression - in this case, creating a tuple.</p>
<p>Another way to use Python code in a rule is to write custom tests for
matching. Sometimes it&#8217;s more convenient to write some Python that
determines if a rule matches than to stick to Parsley expressions
alone. For those cases, we can use <cite>?()</cite>. Here, we use the builtin
rule <cite>anything</cite> to match a single character, then a Python predicate
to decide if it&#8217;s the one we want:</p>
<div class="highlight-python"><pre>digit = anything:x ?(x in '0123456789') -&gt; x</pre>
</div>
<p>This rule <cite>digit</cite> will match any decimal digit. We need the <cite>-&gt; x</cite> on
the end to return the character rather than the value of the predicate
expression, which is just <cite>True</cite>.</p>
</div>
<div class="section" id="repeated-matches-make-lists">
<h3>Repeated Matches Make Lists<a class="headerlink" href="#repeated-matches-make-lists" title="Permalink to this headline">¶</a></h3>
<p>Like regular expressions, Parsley supports repeating matches. You can
match an expression zero or more times with &#8216;* &#8216;, one or more times
with &#8216;+&#8217;, and a specific number of times with &#8216;{n, m}&#8217; or just
&#8216;{n}&#8217;. Since all expressions in Parsley return a value, these
repetition operators return a list containing each match they made.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">parsley</span><span class="o">.</span><span class="n">makeGrammar</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">digit = anything:x ?(x in &#39;0123456789&#39;) -&gt; x</span>
<span class="s">number = digit+</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">{})</span>
<span class="k">print</span> <span class="n">x</span><span class="p">(</span><span class="s">&quot;314159&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">number</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="s">&#39;3&#39;</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;4&#39;</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;5&#39;</span><span class="p">,</span> <span class="s">&#39;9&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The <cite>number</cite> rule repeatedly matches <cite>digit</cite> and collects the matches
into a list. This gets us part way to turning a string like <cite>314159</cite>
into an integer. All we need now is to turn the list back into a
string and call <cite>int()</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">parsley</span><span class="o">.</span><span class="n">makeGrammar</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">digit = anything:x ?(x in &#39;0123456789&#39;) -&gt; x</span>
<span class="s">number = digit+:ds -&gt; int(&#39;&#39;.join(ds))</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">{})</span>
<span class="k">print</span> <span class="n">x</span><span class="p">(</span><span class="s">&quot;8675309&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">number</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">8675309</span>
</pre></div>
</div>
</div>
<div class="section" id="collecting-chunks-of-input">
<h3>Collecting Chunks Of Input<a class="headerlink" href="#collecting-chunks-of-input" title="Permalink to this headline">¶</a></h3>
<p>If it seemed kind of strange to break our input string up into a list
and then reassemble it into a string using <cite>join</cite>, you&#8217;re not
alone. Parsley has a shortcut for this since it&#8217;s a common case: you
can use <cite>&lt;&gt;</cite> around a rule to make it return the slice of input it
consumes, ignoring the actual return value of the rule. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">parsley</span><span class="o">.</span><span class="n">makeGrammar</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">digit = anything:x ?(x in &#39;0123456789&#39;)</span>
<span class="s">number = &lt;digit+&gt;:ds -&gt; int(ds)</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">{})</span>
<span class="k">print</span> <span class="n">x</span><span class="p">(</span><span class="s">&quot;11235&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">number</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">11235</span>
</pre></div>
</div>
<p>Here, <cite>&lt;digit+&gt;</cite> returns the string <cite>&#8220;11235&#8221;</cite>, since that&#8217;s the
portion of the input that <cite>digit+</cite> matched. (In this case it&#8217;s the
entire input, but we&#8217;ll see some more complex cases soon.) Since it
ignores the list returned by <cite>digit+</cite>, leaving the <cite>-&gt; x</cite> out of
<cite>digit</cite> doesn&#8217;t change the result.</p>
</div>
</div>
<div class="section" id="building-a-calculator">
<h2>Building A Calculator<a class="headerlink" href="#building-a-calculator" title="Permalink to this headline">¶</a></h2>
<p>Now let&#8217;s look at using these rules in a more complicated parser. We
have support for parsing numbers; let&#8217;s do addition, as well.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">parsley</span><span class="o">.</span><span class="n">makeGrammar</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">digit = anything:x ?(x in &#39;0123456789&#39;)</span>
<span class="s">number = &lt;digit+&gt;:ds -&gt; int(ds)</span>
<span class="s">expr = number:left ( &#39;+&#39; number:right -&gt; left + right</span>
<span class="s">                   | -&gt; left)</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">{})</span>
<span class="k">print</span> <span class="n">x</span><span class="p">(</span><span class="s">&quot;17+34&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
<span class="k">print</span> <span class="n">x</span><span class="p">(</span><span class="s">&quot;18&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">51</span>
<span class="mi">18</span>
</pre></div>
</div>
<p>Parentheses group expressions just like in Python. the &#8216;<cite>|</cite>&#8216; operator
is like <cite>or</cite> in Python - it short-circuits. It tries each expression
until it finds one that matches. For <cite>&#8220;17+34&#8221;</cite>, the <cite>number</cite> rule
matches &#8220;17&#8221;, then Parsley tries to match <cite>+</cite> followed by another
<cite>number</cite>. Since &#8220;+&#8221; and &#8220;34&#8221; are the next things in the input, those
match, and it then runs the Python expression <cite>left + right</cite> and
returns its value. For the input <cite>&#8220;18&#8221;</cite> it does the same, but <cite>+</cite> does
not match, so Parsley tries the next thing after <cite>|</cite>. Since this is
just a Python expression, the match succeeds and the number 18 is
returned.</p>
<p>Now let&#8217;s add subtraction:</p>
<div class="highlight-python"><pre>digit = anything:x ?(x in '0123456789')
number = &lt;digit+&gt;:ds -&gt; int(ds)
expr = number:left ( '+' number:right -&gt; left + right
                   | '-' number:right -&gt; left - right
                   | -&gt; left)</pre>
</div>
<p>This will accept things like &#8216;5-4&#8217; now.</p>
<p>Since parsing numbers is so common and useful, Parsley actually has
&#8216;digit&#8217; as a builtin rule, so we don&#8217;t even need to define it
ourselves. We&#8217;ll leave it out in further examples and rely on the
version Parsley provides.</p>
<p>Normally we like to allow whitespace in our expressions, so let&#8217;s add
some support for spaces:</p>
<div class="highlight-python"><pre>number = &lt;digit+&gt;:ds -&gt; int(ds)
ws = ' '*
expr = number:left ws ('+' ws number:right -&gt; left + right
                      |'-' ws number:right -&gt; left - right
                      | -&gt; left)</pre>
</div>
<p>Now we can handle &#8220;17 +34&#8221;, &#8220;2  - 1&#8221;, etc.</p>
<p>We could go ahead and add multiplication and division here (and
hopefully it&#8217;s obvious how that would work), but let&#8217;s complicate
things further and allow multiple operations in our expressions &#8211;
things like &#8220;1 - 2 + 3&#8221;.</p>
<p>There&#8217;s a couple different ways to do this. Possibly the easiest is to
build a list of numbers and operations, then do the math.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">parsley</span><span class="o">.</span><span class="n">makeGrammar</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">number = &lt;digit+&gt;:ds -&gt; int(ds)</span>
<span class="s">ws = &#39; &#39;*</span>
<span class="s">add = &#39;+&#39; ws number:n -&gt; (&#39;+&#39;, n)</span>
<span class="s">sub = &#39;-&#39; ws number:n -&gt; (&#39;-&#39;, n)</span>
<span class="s">addsub = ws (add | sub)</span>
<span class="s">expr = number:left (addsub+:right -&gt; right</span>
<span class="s">                   | -&gt; left)</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">{})</span>
<span class="k">print</span> <span class="n">x</span><span class="p">(</span><span class="s">&quot;1 + 2 - 3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><pre>[('+', 2), ('-, 3)]</pre>
</div>
<p>Oops, this is only half the job done. We&#8217;re collecting the operators
and values, but now we need to do the actual calculation. The easiest
way to do it is probably to write a Python function and call it from
inside the grammar.</p>
<p>So far we have been passing an empty dict as the second argument to
<tt class="docutils literal"><span class="pre">makeGrammar</span></tt>. This is a dict of variable bindings that can be used
in Python expressions in the grammar. So we can pass Python objects,
such as functions, this way:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">pairs</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">start</span>
    <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">-=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">parsley</span><span class="o">.</span><span class="n">makeGrammar</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">number = &lt;digit+&gt;:ds -&gt; int(ds)</span>
<span class="s">ws = &#39; &#39;*</span>
<span class="s">add = &#39;+&#39; ws number:n -&gt; (&#39;+&#39;, n)</span>
<span class="s">sub = &#39;-&#39; ws number:n -&gt; (&#39;-&#39;, n)</span>
<span class="s">addsub = ws (add | sub)</span>
<span class="s">expr = number:left (addsub+:right -&gt; calculate(left, right)</span>
<span class="s">                   | -&gt; left)</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;calculate&quot;</span><span class="p">:</span> <span class="n">calculate</span><span class="p">})</span>
<span class="k">print</span> <span class="n">x</span><span class="p">(</span><span class="s">&quot;4 + 5 - 6&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">3</span>
</pre></div>
</div>
<p>Introducing this function lets us simplify even further: instead of
using <tt class="docutils literal"><span class="pre">addsub+</span></tt>, we can use <tt class="docutils literal"><span class="pre">addsub*</span></tt>, since <tt class="docutils literal"><span class="pre">calculate(left,</span> <span class="pre">[])</span></tt>
will return <tt class="docutils literal"><span class="pre">left</span></tt> &#8211; so now <tt class="docutils literal"><span class="pre">expr</span></tt> becomes:</p>
<div class="highlight-python"><pre>expr = number:left addsub*:right -&gt; calculate(left, right)</pre>
</div>
<p>So now let&#8217;s look at adding multiplication and division. Here, we run
into precedence rules: should &#8220;4 * 5 + 6&#8221; give us 26, or 44? The
traditional choice is for multiplication and division to take
precedence over addition and subtraction, so the answer should
be 26. We&#8217;ll resolve this by making sure multiplication and division
happen before addition and subtraction are considered:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">pairs</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">start</span>
    <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">-=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">*=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">/=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">parsley</span><span class="o">.</span><span class="n">makeGrammar</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">number = &lt;digit+&gt;:ds -&gt; int(ds)</span>
<span class="s">ws = &#39; &#39;*</span>
<span class="s">add = &#39;+&#39; ws expr2:n -&gt; (&#39;+&#39;, n)</span>
<span class="s">sub = &#39;-&#39; ws expr2:n -&gt; (&#39;-&#39;, n)</span>
<span class="s">mul = &#39;*&#39; ws number:n -&gt; (&#39;*&#39;, n)</span>
<span class="s">div = &#39;/&#39; ws number:n -&gt; (&#39;/&#39;, n)</span>

<span class="s">addsub = ws (add | sub)</span>
<span class="s">muldiv = ws (mul | div)</span>

<span class="s">expr = expr2:left addsub*:right -&gt; calculate(left, right)</span>
<span class="s">expr2 = number:left muldiv*:right -&gt; calculate(left, right)</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;calculate&quot;</span><span class="p">:</span> <span class="n">calculate</span><span class="p">})</span>
<span class="k">print</span> <span class="n">x</span><span class="p">(</span><span class="s">&quot;4 * 5 + 6&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">26</span>
</pre></div>
</div>
<p>Notice particularly that <tt class="docutils literal"><span class="pre">add</span></tt>, <tt class="docutils literal"><span class="pre">sub</span></tt>, and <tt class="docutils literal"><span class="pre">expr</span></tt> all call the
<tt class="docutils literal"><span class="pre">expr2</span></tt> rule now where they called <tt class="docutils literal"><span class="pre">number</span></tt> before. This means
that all the places where a number was expected previously, a
multiplication or division expression can appear instead.</p>
<p>Finally let&#8217;s add parentheses, so you can override the precedence and
write &#8220;4 * (5 + 6)&#8221; when you do want 44. We&#8217;ll do this by adding a
<tt class="docutils literal"><span class="pre">value</span></tt> rule that accepts either a number or an expression in
parentheses, and replace existing calls to <tt class="docutils literal"><span class="pre">number</span></tt> with calls to
<tt class="docutils literal"><span class="pre">value</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">pairs</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">start</span>
    <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">-=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">*=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">/=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">parsley</span><span class="o">.</span><span class="n">makeGrammar</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">number = &lt;digit+&gt;:ds -&gt; int(ds)</span>
<span class="s">parens = &#39;(&#39; ws expr:e ws &#39;)&#39; -&gt; e</span>
<span class="s">value = number | parens</span>
<span class="s">ws = &#39; &#39;*</span>
<span class="s">add = &#39;+&#39; ws expr2:n -&gt; (&#39;+&#39;, n)</span>
<span class="s">sub = &#39;-&#39; ws expr2:n -&gt; (&#39;-&#39;, n)</span>
<span class="s">mul = &#39;*&#39; ws value:n -&gt; (&#39;*&#39;, n)</span>
<span class="s">div = &#39;/&#39; ws value:n -&gt; (&#39;/&#39;, n)</span>

<span class="s">addsub = ws (add | sub)</span>
<span class="s">muldiv = ws (mul | div)</span>

<span class="s">expr = expr2:left addsub*:right -&gt; calculate(left, right)</span>
<span class="s">expr2 = value:left muldiv*:right -&gt; calculate(left, right)</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;calculate&quot;</span><span class="p">:</span> <span class="n">calculate</span><span class="p">})</span>

<span class="k">print</span> <span class="n">x</span><span class="p">(</span><span class="s">&quot;4 * (5 + 6) + 1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expr</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">45</span>
</pre></div>
</div>
<p>And there you have it: a four-function calculator with precedence and
parentheses.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Parsley Tutorial Part I: Basics and Syntax</a><ul>
<li><a class="reference internal" href="#from-regular-expressions-to-grammars">From Regular Expressions To Grammars</a><ul>
<li><a class="reference internal" href="#parsley-grammars-have-named-rules">Parsley Grammars Have Named Rules</a></li>
<li><a class="reference internal" href="#parsley-grammars-are-expressions">Parsley Grammars Are Expressions</a></li>
<li><a class="reference internal" href="#rules-can-embed-python-expressions">Rules Can Embed Python Expressions</a></li>
<li><a class="reference internal" href="#repeated-matches-make-lists">Repeated Matches Make Lists</a></li>
<li><a class="reference internal" href="#collecting-chunks-of-input">Collecting Chunks Of Input</a></li>
</ul>
</li>
<li><a class="reference internal" href="#building-a-calculator">Building A Calculator</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Welcome to Parsley&#8217;s documentation!</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="tutorial2.html"
                        title="next chapter">Parsley Tutorial Part II: Parsing Structured Data</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/tutorial.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="tutorial2.html" title="Parsley Tutorial Part II: Parsing Structured Data"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to Parsley’s documentation!"
             >previous</a> |</li>
        <li><a href="index.html">Parsley 1.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Allen Short.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>