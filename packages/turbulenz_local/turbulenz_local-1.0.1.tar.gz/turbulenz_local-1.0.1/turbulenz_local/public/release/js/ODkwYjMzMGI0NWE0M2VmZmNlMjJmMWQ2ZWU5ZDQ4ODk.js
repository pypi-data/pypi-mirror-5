// Copyright (c) 2011-2012 Turbulenz Limited
/*global Backbone*//*global Templates*//*global window*//*global $*//*jshint nomen: false*//*global _*//*jshint nomen: true*//*exported LocalDeployView*/var LocalDeployView=Backbone.View.extend({el:"body",initialize:function(){return this.app=this.options.app,this.login_template=Templates.local_deploy_login_template,this.select_template=Templates.local_deploy_select_template,this.upload_template=Templates.local_deploy_upload_template,_.bindAll(this,"render","initialiseDeployForms"),this.app.bind("deploy:set",this.setDialogs),this.app.bind("deploy:initialise",this.initialiseDeployForms),this},render:function(){return $(this.el).jqoteapp(this.login_template),$(this.el).jqoteapp(this.select_template),$(this.el).jqoteapp(this.upload_template),this},setDialogs:function(){$("#deploy_login_dialog_id").dialog({autoOpen:!1,height:250,width:400,modal:!0,close:function(){$("#deploy_login_id").val("").removeClass("ui-state-error"),$("#deploy_password_id").val("").removeClass("ui-state-error")}}),$("#deploy_select_dialog_id").dialog({autoOpen:!1,height:340,width:500,modal:!0,close:function(){$("#deploy_select_project_id")[0].options.length=0,$("#deploy_new_version_number_id").val("").removeClass("ui-state-error"),$("#deploy_select_version_id").removeAttr("disabled")[0].options.length=0,$("#deploy_new_version_name_id").val("")}}),$("#deploy_upload_dialog_id").dialog({autoOpen:!1,height:150,width:800,modal:!0}),$("#deploy_upload_bar_id").progressbar({value:0})},initialiseDeployForms:function(e){function w(e){var t=[];e=e.toString();while(3<e.length)t.unshift(e.substr(e.length-3)),e=e.substr(0,e.length-3);return 0<e.length&&t.unshift(e),t.join(",")}function E(e){function m(){if(t){clearTimeout(t),t=undefined;var e=p.progressbar("option","value");return e<100?window.confirm("Do you want to cancel the deploy?")?($.ajax({async:!1,type:"POST",data:f,url:o}),!0):(t=setTimeout(n,g),!1):!0}return!1}function y(){if(t){clearTimeout(t),t=undefined;var e=p.progressbar("option","value");return e<100?(window.alert("Cannot interrupt Post-upload processing"),t=setTimeout(u,g),!1):!0}return!1}function b(e){var r=e.data,i=r.uploaded_files,s=r.uploaded_bytes,o=r.total_files,a=r.num_files,f=r.num_bytes,l;o?i?i<o?(l=100*(s/f),d.text("Uploading modified files: "+i+"/"+o),v.text("Uploading bytes: "+w(s)+"/"+w(f))):(l=100,d.text("Uploading finished."),v.text("")):(l=100*(a/o),d.text("Scanning and compressing files: "+a+"/"+o),v.text("Total bytes: "+w(f))):l=0,p.progressbar("option","value",l),l>=100?(d.text(""),v.text(""),clearTimeout(t),t=undefined,$("#deploy_upload_cancel_id").hide(),h.unbind().bind("dialogbeforeclose",y),t=setTimeout(u,500)):o>1e3?t=setTimeout(n,5*g):t=setTimeout(n,g)}function E(e,t){if("timeout"===t)window.alert("The connection to local.turbulenz timed out.");else{var n=JSON.parse(e.responseText),r=n?n.msg:"unknown",i=e.status;500===i?window.alert("Local.turbulenz failed.\n"+r):window.alert("Hub uploading failed.\n"+r)}h.unbind("dialogbeforeclose",m),h.dialog("close")}function S(e){var n=e.data,r=n.processed,i=n.total,s;i?r<i?(s=100*(r/i),d.text("Post-upload processing progress: "+r+"/"+i),v.text("")):(s=100,d.text("Processing finished."),v.text("")):s=0,p.progressbar("option","value",s);if(s>=100){try{window.alert("Deployment complete"+(n.msg?":\n\n"+n.msg:""))}catch(o){window.alert("Deployment complete")}d.text(""),v.text(""),h.unbind("dialogbeforeclose",y),h.dialog("close"),$("#deploy_upload_cancel_id").show()}else i>1e3?t=setTimeout(u,5*g):t=setTimeout(u,g)}function x(e,t){if("timeout"===t)window.alert("The connection to local.turbulenz timed out.");else{var n=JSON.parse(e.responseText),r=n?n.msg:"unknown",i=e.status;500===i?window.alert("Hub failed.\n"+r):window.alert("Hub post-processing failed.\n"+r)}h.unbind("dialogbeforeclose",y),h.dialog("close")}function T(){h.unbind("dialogbeforeclose",m),h.dialog("close")}function N(){return m()&&(d.text(""),v.text(""),h.unbind("dialogbeforeclose",m),h.dialog("close")),!1}function C(e){l.dialog("close");var r=e.data;r&&(f=r,d.text("Scanning files..."),v.text(""),p.progressbar("option","value",0),c.unbind(),$("#deploy_upload_cancel_id").unbind().click(N),h.unbind().dialog("open").bind("dialogbeforeclose",m),t=setTimeout(n,500))}function k(e,t){if("timeout"===t)window.alert("The connection to the Hub timed out.");else{var n=JSON.parse(e.responseText),r=n?n.msg:"unknown",i=e.status;500===i?window.alert("Local.turbulenz is not setup correctly.\n"+r):window.alert("Hub log in details are incorrect.\n"+r)}}var t,n,u,a,f;a="local="+e.local+"&"+e.cookie+"&project="+e.project+"&version="+e.version,e.versiontitle&&(a+="&versiontitle="+e.versiontitle),n=function(){$.ajax({async:!1,type:"POST",data:f,url:i,success:b,error:E})},u=function(){$.ajax({async:!1,type:"POST",data:f,url:s,success:S,error:x})},c.unbind(),c.submit(T),$.ajax({async:!1,timeout:1e4,type:"POST",url:r,data:a,success:C,error:k})}function S(e){function f(e){return $("<div/>").html(e).text()}function d(){function e(e,t){var n=e.version.split("."),r=t.version.split(".");for(var i=0;n[i]&&r[i];i+=1){var s=n[i],o=r[i];if(s!==o){var u=Number(s),a=Number(o);return isNaN(u)||isNaN(a)?n[i]<r[i]?1:-1:a-u}}return r.length-n.length}a.length=0;var t=s.find("option:selected").index(),r=n[t],i=r.versions,o,f,l,c;if(i){o=i.length,1<o&&i.sort(e);for(c=0;c<o;c+=1)f=i[c],l=f.version,u.append($("<option></option>").attr("value",l).text(l))}var h=r.locked_versions;if(h){o=h.length,1<o&&h.sort(e);for(c=0;c<o;c+=1)f=h[c],l=f.version,u.append($("<option></option>").attr("disabled","disabled").attr("value",l).text(l+" (locked)"))}(!i||i.length===0)&&u.prepend($("<option></option>").attr("disabled","disabled").attr("value","").text("No Writable Versions"))}function v(){var e=$.trim(i.val());e?u.attr("disabled",!0):u.removeAttr("disabled")}var t=e.data,n=t.projects,r=n?n.length:0,i=$("#deploy_new_version_number_id"),s=$("#deploy_select_project_id"),o=s[0].options,u=$("#deploy_select_version_id"),a=u[0].options;$("body").css("cursor","auto");if(r<1){window.alert("This user has no projects on Hub that you can deploy to.");return}y=t.cookie,r>1&&(n[0].modified?n.sort(function(e,t){return t.modified-e.modified}):n.sort(function(e,t){return t.created-e.created}));for(var c=0;c<r;c+=1){var h=n[c],p=new Option(f(h.title),h.slug);o[o.length]=p,c===0&&u.val(h.slug)}d(),s.unbind(),s.change(d),i.unbind(),i.change(v),l.dialog("open")}function x(){var e=!0,t=$("#deploy_login_id"),r=$("#deploy_password_id"),i=$.trim(t.val()),s=$.trim(r.val()),o=$("#rememberme").attr("checked");t.removeClass("ui-state-error"),r.removeClass("ui-state-error"),i||(t.addClass("ui-state-error"),e=!1),s||(r.addClass("ui-state-error"),e=!1);if(e){var u="login="+i+"&password="+s;$("body").css("cursor","wait"),$.ajax({timeout:1e4,type:"POST",url:n,data:u,success:function(){o?(b.tempLogin=i,b.tempPassword=s,b.rememberme=!0):(b.tempLogin=null,b.tempPassword=null,b.rememberme=!1),S.apply(this,arguments)},error:function(t,n){$("body").css("cursor","auto");var r=t.status;if("timeout"===n)window.alert("The connection to the Hub timed out.");else if(r===500)window.alert("Connection to the Hub failed. Please try again later");else{var i=JSON.parse(t.responseText),s=i?i.msg:"unknown";window.alert("Hub log in failed.\n"+s)}}}),a.dialog("close")}return!1}function T(){var t=!0,n={},r=$("#deploy_select_project_id"),i=$("#deploy_select_version_id"),s=$("#deploy_new_version_number_id"),o=$("#deploy_new_version_name_id"),u=r.val(),a=i.val(),f=$.trim(s.val()),l=$.trim(o.val());return s.removeClass("ui-state-error"),o.removeClass("ui-state-error"),f?m.test(f)?(n.version=f,n.versiontitle=l):(s.addClass("ui-state-error"),t=!1):a?n.version=a:(s.addClass("ui-state-error"),t=!1),t&&(n.project=u,n.cookie=y,n.local=e,h.dialog("option","title","Deploying "+e+" to "+n.version),E(n)),!1}var t=this.app.router,n=t.get("deploy-login"),r=t.get("deploy-start"),i=t.get("deploy-progress"),s=t.get("deploy-postupload-progress"),o=t.get("deploy-cancel"),u=$("#deploy_login_form_id"),a=$("#deploy_login_dialog_id"),f=$("#deploy_select_form_id"),l=$("#deploy_select_dialog_id"),c=$("#deploy_upload_form_id"),h=$("#deploy_upload_dialog_id"),p=$("#deploy_upload_bar_id"),d=$("#deploy_upload_files_counter_id"),v=$("#deploy_upload_bytes_counter_id"),m=new RegExp("^[a-z0-9]+[a-z0-9-\\.]*$"),g=100,y=null,b=this;u.unbind(),f.unbind(),u.submit(x),f.submit(T),this.rememberme&&this.tempLogin&&this.tempPassword&&(u.find('input[name="login"]').val(this.tempLogin),u.find('input[name="password"]').val(this.tempPassword),u.find('input[name="rememberme"]').attr("checked",!0))}});