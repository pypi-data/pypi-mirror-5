var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__slice=[].slice,__bind=function(e,t){return function(){return e.apply(t,arguments)}};define(["mediator","underscore","backbone","./channels"],function(e,t,n,r){var i,s,o,u,a,f,l,c,h,p,d;return u=function(e){var t;return(e.type==="and"||e.type==="or")&&((t=e.children)!=null?t.length:void 0)>=2},f=function(e){return e.operator&&e.id&&e.value!=null},a=function(e){return e.composite===!0&&e.id},s=function(e){function n(){return h=n.__super__.constructor.apply(this,arguments),h}return __extends(n,e),n.prototype.validate=function(e){var t,n;if(u(e)||f(e)||a(e))return;for(t in e){n=e[t];if(n!=null)return"Unknown node type"}},n.prototype.toJSON=function(){var e;return e=null,this.isBranch()?e={type:this.get("type"),children:t.map(this.get("children"),function(e){return e.toJSON!=null?e.toJSON():e})}:this.isComposite()?e={id:this.get("id"),composite:this.get("composite")}:this.isCondition()&&(e={id:this.get("id"),operator:this.get("operator"),value:this.get("value")}),e},n.prototype.isRoot=function(){return this.parent==null},n.prototype.isEmpty=function(){return t.isEmpty(this.attributes)},n.prototype.isBranch=function(){return u(this.attributes)},n.prototype.isCondition=function(){return f(this.attributes)},n.prototype.isComposite=function(){return a(this.attributes)},n.prototype.siblings=function(){return this.isRoot()?!1:t.without(this.parent.get("children"),this)},n.prototype.promote=function(){var e,n,r,i=this;n=1<=arguments.length?__slice.call(arguments,0):[];if(n.length===0)throw new Error("At least one node must be supplied");return this.isRoot()?r="and":r=this.parent.get("type")==="and"?"or":"and",e=t.map([this.attributes].concat(__slice.call(n)),function(e){return l(e,i)}),this.clear({slient:!0}),this.set({type:r,children:e}),this},n.prototype.demote=function(){return this.isRoot()?!1:this.parent.isRoot()?this.siblings().length===0?(this.parent.clear({silent:!0}),this.parent.set(this.attributes),this.parent):!1:(this.parent.parent.get("children").push(this.remove()),this)},n.prototype.add=function(){var e,t;e=1<=arguments.length?__slice.call(arguments,0):[];if(!this.isBranch())throw new Error('Node is not a branch. Use "promote" to convert it into one');return(t=this.get("children")).push.apply(t,e),this},n.prototype.remove=function(){var e,t;return this.isRoot()?this.clear():(e=this.parent.get("children"),(t=e.indexOf(this))>=0&&(e.splice(t,1)[0],e.length===1&&e[0].demote())),this},n}(n.Model),l=function(e,n,r){var i,o;if(!e||t.isEmpty(e))o=new s;else if(e instanceof s)o=e;else if(u(e))o=new s({type:e.type}),i=t.map(e.children,function(e){return l(e,o,r)}),o.set({children:i});else if(f(e))o=new s(e);else{if(!a(e))throw new Error("Unknown node type");o=new s(e)}return n&&(o.parent=n),typeof r=="function"&&r(o),o},c=function(e,t){var n,r,i,s,o,u,a;if(e.isBranch()){n=e.get("children"),u=t.children,a=[];for(r=s=0,o=u.length;s<o;r=++s)i=u[r],a.push(c(n[r],i));return a}return e.set(t)},i=function(n){function i(){return this._deferenceNode=__bind(this._deferenceNode,this),this._referenceNode=__bind(this._referenceNode,this),this._nodeSave=__bind(this._nodeSave,this),this.save=__bind(this.save,this),this.parse=__bind(this.parse,this),p=i.__super__.constructor.apply(this,arguments),p}return __extends(i,n),i.prototype.deferred={save:!0,clear:!0,add:!1,remove:!1},i.prototype.url=function(){return this.isNew()?i.__super__.url.apply(this,arguments):this.get("_links").self.href},i.prototype.initialize=function(){var n,o,u,a=this;i.__super__.initialize.apply(this,arguments),(n=this.nodes)==null&&(this.nodes={}),(o=this.clientNodes)==null&&(this.clientNodes={}),(u=this.root)==null&&(this.root=new s);if(this.isArchived()){this.resolve();return}return this.on("sync",function(){return this.resolve(),e.publish(r.DATACONTEXT_SYNCED,this,"success")}),this.on("error",function(){return e.publish(r.DATACONTEXT_SYNCED,this,"error")}),this.on("change",function(){return e.publish(r.DATACONTEXT_CHANGED,this)}),e.subscribe(r.DATACONTEXT_PAUSE,function(e){if(a.id===e||!e&&a.isSession())return a.pending()}),e.subscribe(r.DATACONTEXT_RESUME,function(e){if(a.id===e||!e&&a.isSession())return a.resolve()}),e.subscribe(r.DATACONTEXT_ADD,function(e,n){t.isNumber(e)||(n=e,e=null);if(a.id===e||!e&&a.isSession())return a.add(n)}),e.subscribe(r.DATACONTEXT_REMOVE,function(e,n){t.isNumber(e)||(n=e,e=null);if(a.id===e||!e&&a.isSession())return a.remove(n)}),e.subscribe(r.DATACONTEXT_CLEAR,function(e){if(a.id===e||!e&&a.isSession())return a.clear()}),this.resolve()},i.prototype.parse=function(e){return e&&(this.root?c(this.root,e.json):(this.nodes={},this.clientNodes={},this.root=l(e.json,null,this._referenceNode))),e},i.prototype.save=function(){return this.set("json",this.root.toJSON()),i.__super__.save.apply(this,arguments),e.publish(r.DATACONTEXT_SYNCING,this),this.pending()},i.prototype.toJSON=function(){var e;return e={id:this.id,name:this.get("name"),json:null,description:this.get("description"),keywords:this.get("keywords"),published:this.get("published"),archived:this.get("archived"),composite:this.get("composite"),session:this.get("session")},this.root&&!this.root.isEmpty()&&(e.json=this.root.toJSON()),e},i.prototype._nodeSave=function(e){if(e.get("id")!=null&&e.get("value")!=null)return this.save()},i.prototype._referenceNode=function(e){var t;if(e.id==null)return;return(t=this.nodes[e.id])||(t=this.nodes[e.id]=[]),t.indexOf(e)===-1&&t.push(e),this.clientNodes[e.cid]=e,e.on("change",this._nodeSave)},i.prototype._deferenceNode=function(e){var t,n;return(t=this.nodes[e.id])&&(n=t.indexOf(e))>=0&&t.splice(n,1),delete this.clientNodes[e.cid],e.off("change",this._nodeSave)},i.prototype.isSession=function(){return this.get("session")},i.prototype.isArchived=function(){return this.get("archived")},i.prototype.getNodes=function(e){return this.nodes[e]||[]},i.prototype.add=function(e){var t;if(!this.clientNodes[e.cid])return this._referenceNode(e),this.root.isEmpty()?this.root=e:this.root.isBranch()&&!this.root.id?this.root.get("children").push(e):(t=new s({type:"and",children:[this.root,e]}),this.root=t),this.save()},i.prototype.remove=function(e){var t,n;if(this.clientNodes[e.cid])return e===this.root?this.root=new s:this.root.isBranch()&&(t=this.root.get("children"),(n=t.indexOf(e))>=0&&t.splice(n,1)[0],t.length===1&&(this.root=t[0])),this._deferenceNode(e),this.save()},i.prototype.clear=function(){var e,t,n;n=this.clientNodes;for(e in n)t=n[e],t.off("change",this._nodeSave);return this.nodes={},this.clientNodes={},this.root.id?this.root=new s:this.root.clear(),this.save()},i}(n.Model),o=function(e){function t(){return d=t.__super__.constructor.apply(this,arguments),d}return __extends(t,e),t.prototype.model=i,t.prototype.initialize=function(){return t.__super__.initialize.apply(this,arguments),this.on("reset",function(e){var t,n,r,i;this.resolve(),i=e.models;for(n=0,r=i.length;n<r;n++)t=i[n],t.trigger("sync")})},t.prototype.getSession=function(){return this.filter(function(e){return e.get("session")})[0]},t.prototype.hasSession=function(){return!!this.getSession()},t}(n.Collection),{DataContextNode:s,DataContext:i,DataContexts:o}});