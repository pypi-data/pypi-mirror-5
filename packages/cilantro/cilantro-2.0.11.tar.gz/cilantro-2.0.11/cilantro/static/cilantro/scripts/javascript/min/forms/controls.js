var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define(["environ","mediator","jquery","underscore","backbone","serrano"],function(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d,v,m,g,y,b;return p=r.template('        <div class=form-actions>            <button class="btn btn-mini btn-danger pull-left" name=remove title="Remove filter">Remove</button>            <button class="btn btn-mini btn-warning" name=exclude title="Exclude results from query">Exclude</button>            <button class="btn btn-mini btn-success" name=include title="Include results in query">Include</button>        </div>    '),l={},a={"click [name=remove]":"clearFilter","click [name=include]":"submitInclude","click [name=exclude]":"submitExclude","change [name=operator]":"toggleOperator"},u=function(e){function o(){return this.loadValues=__bind(this.loadValues,this),this.loadOperators=__bind(this.loadOperators,this),this.loadStats=__bind(this.loadStats,this),v=o.__super__.constructor.apply(this,arguments),v}return __extends(o,e),o.prototype.template=r.template("            <div class=control-group>                <h4 class=control-label>{{ label }} <small class=units>({{ units }})</small></h4>                <div class=controls>                    <select class=span4 name=operator></select>                    <input class=span4 type=text name=value>                    <p class=help-block>{{ help }}</p>                </div>            </div>        "),o.prototype.events=a,o.prototype.deferred={loadStats:!0,loadValues:!0},o.prototype.initialize=function(e){var n=this;return o.__super__.initialize.apply(this,arguments),this.options=e,t.subscribe("datacontext/"+this.model.id+"/edit",function(e){if(e===n.node)return;return n.set(e)})},o.prototype.getTemplateData=function(){return{label:this.model.get("alt_name")||this.model.get("name"),units:this.model.get("plural_unit"),help:this.model.get("description")}},o.prototype.renderTemplate=function(){return this.setElement(this.template(this.getTemplateData())),this.$el.append(p())},o.prototype.render=function(){return this.renderTemplate(),this.$label=this.$(".control-label"),this.$value=this.$("[name=value]"),this.$operator=this.$("[name=operator]"),this.$controls=this.$(".controls"),this.$actions=this.$(".form-actions"),this.$include=this.$("[name=include]"),this.$exclude=this.$("[name=exclude]"),this.$remove=this.$("[name=remove]").hide(),this.options.label===!1&&this.$label.hide(),this.getTemplateData().units||this.$(".units").hide(),this.loadOperators(),this.loadValues(),this.loadStats(),this.$el},o.prototype.show=function(){return this.resolve()},o.prototype.hide=function(){return this.pending()},o.prototype.preventDefault=function(e){return e.preventDefault()},o.prototype.toggleOperator=function(e){return this.toggleActions()},o.prototype.toggleActions=function(e){return l[this.$operator.val()]?this.$exclude.prop("disabled",!1):this.$exclude.prop("disabled",!0)},o.prototype.submitInclude=function(e){return e.preventDefault(),this.submit(this.get())},o.prototype.submitExclude=function(e){return e.preventDefault(),this.submit(this.get({negated:!0}))},o.prototype.clearFilter=function(e){return e.preventDefault(),this.clear()},o.prototype.clear=function(){return this.node&&this.submit(),this.$remove.hide()},o.prototype.validate=function(){},o.prototype.loadStats=function(){var e,t=this;if(!(e=this.model.get("_links").stats))return;return i.ajax({url:e.href,success:function(e){var i,s,o;s=[];for(i in e)o=e[i],i!=="_links"&&o!==null&&(i=i.replace(/[_\-\s]+/," ").trim(),i=i.charAt(0).toUpperCase()+i.substr(1),r.isNumber(o)&&(o=App.Numbers.prettyNumber(o)),s.push(""+i+": "+o));if(s.length)return n("<p>").addClass("help-block").text(s.join(", ")).appendTo(t.$controls)}})},o.prototype.loadOperators=function(){var e,t,n,r,i,s,o;s=t=this.model.get("operators");for(r=0,i=s.length;r<i;r++){o=s[r],e=o[0],n=o[1];if(e.charAt(0)==="-"){l[e.substr(1)]=e;continue}this.$operator.append('<option value="'+e+'">'+n+"</option>")}if(this.$operator.children().length===1)return this.$operator.hide()},o.prototype.loadValues=function(){return this.set()},o.prototype.coerceValue=function(e){var t;t=this.model.get("simple_type");if(e==="null")return null;switch(t){case"boolean":e=e==="true"?!0:!1;break;case"number":e=parseFloat(e)}return e},o.prototype.getValue=function(e){var t,n;if(this.$value.is("[type=checkbox],[type=radio]"))n=this.$value.prop("checked");else{n=this.$value.val();if(n===""||n===null)return;this.$value.is("select[multiple]")?n=function(){var e,r,i;i=[];for(e=0,r=n.length;e<r;e++)t=n[e],i.push(this.coerceValue(t));return i}.call(this):n=this.coerceValue(n)}return n},o.prototype.getOperator=function(e){var t;return e==null&&(e={}),t=this.$operator.val(),e.negated&&l[t]&&(t=l[t]),t},o.prototype.setValue=function(e){return e==null&&(e=null),this.$value.is("[type=checkbox],[type=radio]")?this.$value.prop("checked",e):this.$value.val(e)},o.prototype.setOperator=function(e){return this.$operator.val(e),this.toggleOperator()},o.prototype.get=function(e){return{id:this.model.id,operator:this.getOperator(e),value:this.getValue(e)}},o.prototype.set=function(e){var t,n;e=e||this.node;if(!e)return;return this.node=e,n=this.node.get("value"),t=this.node.get("operator"),/^-/.test(t)&&(t=t.substr(1)),this.setOperator(t),this.setValue(n),this.$remove.show()},o.prototype.submit=function(e){var n;e==null&&(e={});if(e.value===void 0){this.node&&(t.publish(s.DATACONTEXT_REMOVE,this.node),this.$remove.hide());return}if(n=this.validate(e)){this.trigger("error",n);return}return this.node?this.node.set(e):this.node=new s.DataContextNode(e),t.publish(s.DATACONTEXT_ADD,this.node),this.$remove.show()},o}(i.View),r.extend(u.prototype,i.Events),c=function(e){function t(){return m=t.__super__.constructor.apply(this,arguments),m}return __extends(t,e),t.prototype.template=r.template("            <div class=control-group>                <h4 class=control-label>{{ label }} <small class=units>({{ units }})</small></h4>                <div class=controls>                    <select class=span4 name=operator></select>                    <input class=span4 type=text name=value>                    <input class=span4 type=text name=value-2>                    <p class=help-block>{{ help }}</p>                </div>            </div>        "),t.prototype.render=function(){return t.__super__.render.apply(this,arguments),this.$value2=this.$("[name=value-2]").hide(),this.$el},t.prototype.getValue=function(e){var n,r;if(!(n=t.__super__.getValue.apply(this,arguments)))return;return/range/.test(this.getOperator())?(r=this.coerceValue(this.$value2.val()),[n,r]):n},t.prototype.setValue=function(e){return e==null&&(e=null),/range/.test(this.getOperator())?(this.$value.val(e[0]),this.$value2.val(e[1]).show()):this.$value.val(e)},t.prototype.toggleOperator=function(){return t.__super__.toggleOperator.apply(this,arguments),/range/.test(this.getOperator())?this.$value2.show():this.$value2.hide()},t}(u),d=function(e,t){var n,r,i,s,o,u,a,f;o=Math.max(e.length-1,0);if(!o)return;n=[],s=[];for(r=a=0,f=Math.min(3,o);0<=f?a<=f:a>=f;r=0<=f?++a:--a)i=parseInt(Math.random()*o),s.indexOf(i)===-1&&(s.push(i),(u=t(e[i]))&&n.push(u));return"e.g. "+n.join(", ")},f=function(e){function t(){return this.loadValues=__bind(this.loadValues,this),this.loadOperators=__bind(this.loadOperators,this),g=t.__super__.constructor.apply(this,arguments),g}return __extends(t,e),t.prototype.template=r.template('            <div class=control-group>                <h4 class=control-label>{{ label }} <small class=units>({{ units }})</small></h4>                <div class=controls>                    <select class=span4 name=operator></select>                    <div class="input-prepend">                        <span class=add-on><i class=icon-search></i></span><input type=text name=value autocomplete=off>                    </div>                    <p class=help-block>{{ help }}</p>                </div>            </div>        '),t.prototype.initialize=function(e){return t.__super__.initialize.apply(this,arguments)},t.prototype.setValue=function(e){if(e)return this.$value.val(e.join(", "))},t.prototype.getValue=function(){var e,t,n;e=this.$value.data("typeahead"),n=function(){var n,r,i,s;i=e.selections,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(this.coerceValue(e.parse(t)));return s}.call(this);if(!n.length)return;return n},t.prototype.loadOperators=function(){return t.__super__.loadOperators.apply(this,arguments),this.$operator.val("in").hide()},t.prototype.loadValues=function(){var e,t=this;return this.$value.typeahead({mode:"multiple"}),e=this.$value.data("typeahead"),i.ajax({url:this.model.get("_links").values.href,beforeSend:function(){return e.$menu.addClass("loading")},success:function(n){var r;e.source=n,e.$menu.removeClass("loading"),t.set();if(r=d(n,function(e){return e.value}))return t.$value.attr("placeholder",r)}})},t}(u),h=function(e){function t(){return this.loadValues=__bind(this.loadValues,this),y=t.__super__.constructor.apply(this,arguments),y}return __extends(t,e),t.prototype.loadValues=function(){var e,t,n=this;return this.set(),t=this.model.get("_links").values.href,e=null,i.ajax({url:""+t+"?random=3",success:function(e){var t;if(t=d(e,function(e){return e.value}))return n.$value.attr("placeholder",t)}}),this.$value.typeahead({mode:"multiple",items:20,source:r.debounce(function(r,s){if(r===e)return;s.show().$menu.addClass("loading"),n.$value.prop("disabled",!0),i.ajax({url:""+t+"?query="+r,success:function(t){return e=r,s.$menu.removeClass("loading"),s.process(t),n.$value.prop("disabled",!1)}})},500)})},t}(f),o=function(e){function t(){return b=t.__super__.constructor.apply(this,arguments),b}return __extends(t,e),t.prototype.template=r.template("            <div class=control-group>                <h4 class=control-label>{{ label }} <small class=units>({{ units }})</small></h4>                <div class=controls>                    <select class=span4 name=operator></select>                    <select class=span4 name=value>                        <option value=>---</option>                    </select>                    <p class=help-block>{{ help }}</p>                </div>            </div>        "),t.prototype.loadOperators=function(){return t.__super__.loadOperators.apply(this,arguments),this.$operator.val("exact").hide()},t.prototype.loadValues=function(){var e=this;return this.$value.addClass("loading"),i.ajax({url:this.model.get("_links").values.href,success:function(t){var n,r,i;e.$value.removeClass("loading");for(r=0,i=t.length;r<i;r++)n=t[r],e.$value.append('<option value="'+n.value+'">'+n.label+"</option>");return e.set()}})},t}(u),{Control:u,NumberControl:c,EnumerableControl:f,SearchableControl:h,BooleanControl:o}});