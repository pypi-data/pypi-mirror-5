define(["jquery","underscore"],function(e,t){var n=Array.prototype.splice;Backbone={},Backbone.VERSION="0.9.2",Backbone.$=e,Backbone.emulateHTTP=!1,Backbone.emulateJSON=!1;var r=/\s+/,i=Backbone.Events={on:function(e,t,n){var i,s,o;if(!t)return this;e=e.split(r),i=this._callbacks||(this._callbacks={});while(s=e.shift())o=i[s]||(i[s]=[]),o.push(t,n);return this},off:function(e,n,i){var s,o,u,a;if(!(o=this._callbacks))return this;if(!(e||n||i))return delete this._callbacks,this;e=e?e.split(r):t.keys(o);while(s=e.shift()){if(!(u=o[s])||!n&&!i){delete o[s];continue}for(a=u.length-2;a>=0;a-=2)n&&u[a]!==n||i&&u[a+1]!==i||u.splice(a,2)}return this},trigger:function(e){var t,n,i,s,o,u,a,f;if(!(n=this._callbacks))return this;f=[],e=e.split(r);for(s=1,o=arguments.length;s<o;s++)f[s-1]=arguments[s];while(t=e.shift()){if(a=n.all)a=a.slice();if(i=n[t])i=i.slice();if(i)for(s=0,o=i.length;s<o;s+=2)i[s].apply(i[s+1]||this,f);if(a){u=[t].concat(f);for(s=0,o=a.length;s<o;s+=2)a[s].apply(a[s+1]||this,u)}}return this}};i.bind=i.on,i.unbind=i.off;var s=Backbone.Model=function(e,n){var r;e||(e={}),n&&n.parse&&(e=this.parse(e));if(r=S(this,"defaults"))e=t.extend({},r,e);n&&n.collection&&(this.collection=n.collection),this.attributes={},this._escapedAttributes={},this.cid=t.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(e,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=t.clone(this.attributes),this.initialize.apply(this,arguments)};t.extend(s.prototype,i,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(e){return t.clone(this.attributes)},get:function(e){return this.attributes[e]},escape:function(e){var n;if(n=this._escapedAttributes[e])return n;var r=this.get(e);return this._escapedAttributes[e]=t.escape(r==null?"":""+r)},has:function(e){return this.get(e)!=null},set:function(e,n,r){var i,o,u;t.isObject(e)||e==null?(i=e,r=n):(i={},i[e]=n),r||(r={});if(!i)return this;i instanceof s&&(i=i.attributes);if(r.unset)for(o in i)i[o]=void 0;if(!this._validate(i,r))return!1;this.idAttribute in i&&(this.id=i[this.idAttribute]);var a=r.changes={},f=this.attributes,l=this._escapedAttributes,c=this._previousAttributes||{};for(o in i){u=i[o];if(!t.isEqual(f[o],u)||r.unset&&t.has(f,o))delete l[o],(r.silent?this._silent:a)[o]=!0;r.unset?delete f[o]:f[o]=u,!t.isEqual(c[o],u)||t.has(f,o)!=t.has(c,o)?(this.changed[o]=u,r.silent||(this._pending[o]=!0)):(delete this.changed[o],delete this._pending[o])}return r.silent||this.change(r),this},unset:function(e,n){return n=t.extend({},n,{unset:!0}),this.set(e,null,n)},clear:function(e){return e=t.extend({},e,{unset:!0}),this.set(t.clone(this.attributes),e)},fetch:function(e){e=e?t.clone(e):{};var n=this,r=e.success;return e.success=function(t,i,s){if(!n.set(n.parse(t,s),e))return!1;r&&r(n,t)},e.error=Backbone.wrapError(e.error,n,e),(this.sync||Backbone.sync).call(this,"read",this,e)},save:function(e,n,r){var i,s;t.isObject(e)||e==null?(i=e,r=n):(i={},i[e]=n),r=r?t.clone(r):{};if(r.wait){if(!this._validate(i,r))return!1;s=t.clone(this.attributes)}var o=t.extend({},r,{silent:!0});if(i&&!this.set(i,r.wait?o:r))return!1;var u=this,a=r.success;r.success=function(e,n,s){var o=u.parse(e,s);r.wait&&(delete r.wait,o=t.extend(i||{},o));if(!u.set(o,r))return!1;a?a(u,e):u.trigger("sync",u,e,r)},r.error=Backbone.wrapError(r.error,u,r);var f=this.isNew()?"create":"update",l=(this.sync||Backbone.sync).call(this,f,this,r);return r.wait&&this.clear(o).set(s,o),l},destroy:function(e){e=e?t.clone(e):{};var n=this,r=e.success,i=function(){n.trigger("destroy",n,n.collection,e)};if(this.isNew())return i(),!1;e.success=function(t){e.wait&&i(),r?r(n,t):n.trigger("sync",n,t,e)},e.error=Backbone.wrapError(e.error,n,e);var s=(this.sync||Backbone.sync).call(this,"delete",this,e);return e.wait||i(),s},url:function(){var e=S(this,"urlRoot")||S(this.collection,"url")||x();return this.isNew()?e:e+(e.charAt(e.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},change:function(e){e||(e={});var n=this._changing;this._changing=!0;for(var r in this._silent)this._pending[r]=!0;var i=t.extend({},e.changes,this._silent);this._silent={};for(var r in i)this.trigger("change:"+r,this,this.get(r),e);if(n)return this;while(!t.isEmpty(this._pending)){this._pending={},this.trigger("change",this,e);for(var r in this.changed){if(this._pending[r]||this._silent[r])continue;delete this.changed[r]}this._previousAttributes=t.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(e){return e==null?!t.isEmpty(this.changed):t.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?t.clone(this.changed):!1;var n,r=!1,i=this._previousAttributes;for(var s in e){if(t.isEqual(i[s],n=e[s]))continue;(r||(r={}))[s]=n}return r},previous:function(e){return e==null||!this._previousAttributes?null:this._previousAttributes[e]},previousAttributes:function(){return t.clone(this._previousAttributes)},isValid:function(){return!this.validate||!this.validate(this.attributes)},_validate:function(e,n){if(n.silent||!this.validate)return!0;e=t.extend({},this.attributes,e);var r=this.validate(e,n);return r?(n&&n.error?n.error(this,r,n):this.trigger("error",this,r,n),!1):!0}});var o=Backbone.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),t.comparator!==undefined&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,{silent:!0,parse:t.parse})};t.extend(o.prototype,i,{model:s,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},add:function(e,r){var i,s,o,u,a,f,l={},c={},h=[];r||(r={}),e=t.isArray(e)?e.slice():[e];for(i=0,o=e.length;i<o;i++){if(!(u=e[i]=this._prepareModel(e[i],r)))throw new Error("Can't add an invalid model to a collection");a=u.cid,f=u.id;if(l[a]||this._byCid[a]||f!=null&&(c[f]||this._byId[f])){h.push(i);continue}l[a]=c[f]=u}i=h.length;while(i--)h[i]=e.splice(h[i],1)[0];for(i=0,o=e.length;i<o;i++)(u=e[i]).on("all",this._onModelEvent,this),this._byCid[u.cid]=u,u.id!=null&&(this._byId[u.id]=u);this.length+=o,s=r.at!=null?r.at:this.models.length,n.apply(this.models,[s,0].concat(e)),this.comparator&&r.at==null&&this.sort({silent:!0});if(r.silent)return this;for(i=0,o=this.models.length;i<o;i++){if(!l[(u=this.models[i]).cid])continue;r.index=i,u.trigger("add",u,this,r)}if(r.merge)for(i=0,o=h.length;i<o;i++)(u=this._byId[h[i].id])&&u.set(h[i],r);return this},remove:function(e,n){var r,i,s,o;n||(n={}),e=t.isArray(e)?e.slice():[e];for(r=0,i=e.length;r<i;r++){o=this.getByCid(e[r])||this.get(e[r]);if(!o)continue;delete this._byId[o.id],delete this._byCid[o.cid],s=this.indexOf(o),this.models.splice(s,1),this.length--,n.silent||(n.index=s,o.trigger("remove",o,this,n)),this._removeReference(o)}return this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,t),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,n){return e=this._prepareModel(e,n),this.add(e,t.extend({at:0},n)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(e,t){return this.models.slice(e,t)},get:function(e){return e==null?void 0:this._byId[e.id!=null?e.id:e]},getByCid:function(e){return e&&this._byCid[e.cid||e]},at:function(e){return this.models[e]},where:function(e){return t.isEmpty(e)?[]:this.filter(function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0})},sort:function(e){e||(e={});if(!this.comparator)throw new Error("Cannot sort a set without a comparator");var n=t.bind(this.comparator,this);return this.comparator.length==1?this.models=this.sortBy(n):this.models.sort(n),e.silent||this.trigger("reset",this,e),this},pluck:function(e){return t.map(this.models,function(t){return t.get(e)})},reset:function(e,n){e||(e=[]),n||(n={});for(var r=0,i=this.models.length;r<i;r++)this._removeReference(this.models[r]);return this._reset(),this.add(e,t.extend({silent:!0},n)),n.silent||this.trigger("reset",this,n),this},fetch:function(e){e=e?t.clone(e):{},e.parse===undefined&&(e.parse=!0);var n=this,r=e.success;return e.success=function(t,i,s){n[e.add?"add":"reset"](n.parse(t,s),e),r&&r(n,t)},e.error=Backbone.wrapError(e.error,n,e),(this.sync||Backbone.sync).call(this,"read",this,e)},create:function(e,n){var r=this;n=n?t.clone(n):{},e=this._prepareModel(e,n);if(!e)return!1;n.wait||r.add(e,n);var i=n.success;return n.success=function(t,s,o){n.wait&&r.add(t,n),i?i(t,s):t.trigger("sync",e,s,n)},e.save(null,n),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models)},chain:function(){return t(this.models).chain()},_reset:function(e){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(e,t){if(e instanceof s)return e.collection||(e.collection=this),e;t||(t={}),t.collection=this;var n=new this.model(e,t);return n._validate(n.attributes,t)?n:!1},_removeReference:function(e){this==e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){if((e=="add"||e=="remove")&&n!=this)return;e=="destroy"&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],t.id!=null&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments)}});var u=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];t.each(u,function(e){o.prototype[e]=function(){return t[e].apply(t,[this.models].concat(t.toArray(arguments)))}});var a=Backbone.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},f=/:\w+/g,l=/\*\w+/g,c=/[-[\]{}()+?.,\\^$|#\s]/g;t.extend(a.prototype,i,{initialize:function(){},route:function(e,n,r){return Backbone.history||(Backbone.history=new h),t.isRegExp(e)||(e=this._routeToRegExp(e)),r||(r=this[n]),Backbone.history.route(e,t.bind(function(t){var i=this._extractParameters(e,t);r&&r.apply(this,i),this.trigger.apply(this,["route:"+n].concat(i)),Backbone.history.trigger("route",this,n,i)},this)),this},navigate:function(e,t){Backbone.history.navigate(e,t)},_bindRoutes:function(){if(!this.routes)return;var e=[];for(var t in this.routes)e.unshift([t,this.routes[t]]);for(var n=0,r=e.length;n<r;n++)this.route(e[n][0],e[n][1],this[e[n][1]])},_routeToRegExp:function(e){return e=e.replace(c,"\\$&").replace(f,"([^/]+)").replace(l,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){return e.exec(t).slice(1)}});var h=Backbone.History=function(){this.handlers=[],t.bindAll(this,"checkUrl")},p=/^[#\/]/,d=/msie [\w.]+/;h.started=!1,t.extend(h.prototype,i,{interval:50,getHash:function(e){var t=e?e.location:window.location,n=t.href.match(/#(.*)$/);return n?n[1]:""},getFragment:function(e,t){return e==null&&(this._hasPushState||!this._wantsHashChange||t?e=window.location.pathname:e=this.getHash()),e.indexOf(this.options.root)||(e=e.substr(this.options.root.length)),e.replace(p,"")},start:function(e){if(h.started)throw new Error("Backbone.history has already been started");h.started=!0,this.options=t.extend({},{root:"/"},this.options,e),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var n=this.getFragment(),r=document.documentMode,i=d.exec(navigator.userAgent.toLowerCase())&&(!r||r<=7);i&&this._wantsHashChange&&(this.iframe=Backbone.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(n)),this._hasPushState?Backbone.$(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!i?Backbone.$(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=n;var s=window.location,o=s.pathname==this.options.root&&!s.search;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!o)return this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+window.location.search+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&o&&s.hash&&(this.fragment=this.getHash().replace(p,""),window.history.replaceState({},document.title,s.protocol+"//"+s.host+this.options.root+this.fragment));if(!this.options.silent)return this.loadUrl()},stop:function(){Backbone.$(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),h.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();t==this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe)));if(t==this.fragment)return!1;this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(e){var n=this.fragment=this.getFragment(e),r=t.any(this.handlers,function(e){if(e.route.test(n))return e.callback(n),!0});return r},navigate:function(e,t){if(!h.started)return!1;if(!t||t===!0)t={trigger:t};var n=(e||"").replace(p,"");if(this.fragment==n)return;var r=(n.indexOf(this.options.root)!=0?this.options.root:"")+n;if(this._hasPushState)this.fragment=r,window.history[t.replace?"replaceState":"pushState"]({},document.title,r);else{if(!this._wantsHashChange)return window.location.assign(r);this.fragment=n,this._updateHash(window.location,n,t.replace),this.iframe&&n!=this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,n,t.replace))}t.trigger&&this.loadUrl(e)},_updateHash:function(e,t,n){n?e.replace(e.toString().replace(/(javascript:|#).*$/,"")+"#"+t):e.hash=t}});var v=Backbone.View=function(e){this.cid=t.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},m=/^(\S+)\s*(.*)$/,g=["model","collection","el","id","attributes","className","tagName"];t.extend(v.prototype,i,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(e,t,n){var r=document.createElement(e);return t&&Backbone.$(r).attr(t),n!=null&&Backbone.$(r).html(n),r},setElement:function(e,t){return this.$el&&this.undelegateEvents(),this.$el=e instanceof Backbone.$?e:Backbone.$(e),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=S(this,"events")))return;this.undelegateEvents();for(var n in e){var r=e[n];t.isFunction(r)||(r=this[e[n]]);if(!r)throw new Error('Method "'+e[n]+'" does not exist');var i=n.match(m),s=i[1],o=i[2];r=t.bind(r,this),s+=".delegateEvents"+this.cid,o===""?this.$el.bind(s,r):this.$el.delegate(o,s,r)}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(e){this.options&&(e=t.extend({},this.options,e));for(var n=0,r=g.length;n<r;n++){var i=g[n];e[i]&&(this[i]=e[i])}this.options=e},_ensureElement:function(){if(!this.el){var e=t.extend({},S(this,"attributes"));this.id&&(e.id=this.id),this.className&&(e["class"]=this.className),this.setElement(this.make(S(this,"tagName"),e),!1)}else this.setElement(this.el,!1)}});var y=function(e,t){var n=E(this,e,t);return n.extend=this.extend,n};s.extend=o.extend=a.extend=v.extend=y;var b={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};Backbone.sync=function(e,n,r){var i=b[e];r||(r={});var s={type:i,dataType:"json"};return r.url||(s.url=S(n,"url")||x()),!r.data&&n&&(e=="create"||e=="update")&&(s.contentType="application/json",s.data=JSON.stringify(n)),Backbone.emulateJSON&&(s.contentType="application/x-www-form-urlencoded",s.data=s.data?{model:s.data}:{}),Backbone.emulateHTTP&&(i==="PUT"||i==="DELETE")&&(Backbone.emulateJSON&&(s.data._method=i),s.type="POST",s.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",i)}),s.type!=="GET"&&!Backbone.emulateJSON&&(s.processData=!1),Backbone.ajax(t.extend(s,r))},Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments)},Backbone.wrapError=function(e,t,n){return function(r,i){i=r===t?i:r,e?e(t,i,n):t.trigger("error",t,i,n)}};var w=function(){},E=function(e,n,r){var i;return n&&n.hasOwnProperty("constructor")?i=n.constructor:i=function(){e.apply(this,arguments)},t.extend(i,e),w.prototype=e.prototype,i.prototype=new w,n&&t.extend(i.prototype,n),r&&t.extend(i,r),i.prototype.constructor=i,i.__super__=e.prototype,i},S=function(e,n){return!e||!e[n]?null:t.isFunction(e[n])?e[n]():e[n]},x=function(){throw new Error('A "url" property or function must be specified')};return Backbone});